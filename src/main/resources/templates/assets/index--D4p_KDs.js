import{r as y,b as z,j as e,B as c,F as h,u as I,h as ee,T as o,i as se,k as L,M as S,l as te,m as P,D as ae,E as ie,P as K,n as re,z as le,Q as W,U as ne,V as de,W as ce,X as ue,Y as oe,Z as me}from"./vendor-AUb_t5Eg.js";import{u as v,j as k,b as xe,a as _,c as he,i as p,s as pe}from"./index-VNEKRaPw.js";var je=()=>{throw new Error('Using the "css" tag in runtime is not supported. Make sure you have set up the Babel plugin correctly.')},fe=je;const m="/processes";function ge(s,i=500){const[u,j]=y.useState(s);return y.useLayoutEffect(()=>{const n=window.setTimeout(()=>j(s),i);return()=>window.clearTimeout(n)},[s,i]),u}function Me(s){try{return JSON.parse(s)}catch{return{}}}const N=(s,i)=>k(`${m}/${i}/${s}`,"PUT").then(()=>{P.success(p.intl.formatMessage({id:"key0007",defaultMessage:p.intl.formatMessage({id:"key0007",defaultMessage:"{v1}指令已发送"})},{v1:s}))}),q=({logInfo:s,process:i,processesId:u,processesName:j,setProcessesId:n,refetchServerInfo:f,onClick:l,refetchLog:g})=>{const r=z();return e.jsxs("div",{children:[e.jsxs("div",{className:"flex space-x-2 items-center",children:[e.jsx("div",{children:j??""}),e.jsx(W,{bordered:!1,color:s!=null&&s.running?"gold":"grey",className:"flex align-middle cursor-pointer",onClick:l,children:s!=null&&s.running?r.formatMessage({id:"key0060",defaultMessage:"运行中"}):r.formatMessage({id:"key0061",defaultMessage:"未运行"})}),e.jsx(W,{bordered:!1,color:s==null?void 0:s.color,className:"flex align-middle cursor-pointer",onClick:l,children:s==null?void 0:s.label})]}),e.jsxs("div",{className:"text-grey mt-2",children:[e.jsx(o,{title:r.formatMessage({id:"key0014",defaultMessage:"启动服务"}),children:e.jsx(c,{type:"text",disabled:s==null?void 0:s.running,onClick:()=>{N("start",u).then(()=>f())},className:"text-green-600 cursor-pointer",children:e.jsx(ne,{})})}),e.jsx(o,{title:r.formatMessage({id:"key0015",defaultMessage:"关闭服务"}),children:e.jsx(c,{type:"text",disabled:!(s!=null&&s.running),onClick:()=>{N("stop",u).then(()=>f())},className:"text-red-500 cursor-pointer",children:e.jsx(de,{})})}),e.jsx(o,{title:r.formatMessage({id:"key0016",defaultMessage:"重启服务"}),children:e.jsx(c,{type:"text",disabled:!(s!=null&&s.running),onClick:()=>{N("restart",u).then(()=>f())},className:"text-green-600 cursor-pointer",children:e.jsx(ce,{})})}),e.jsx(o,{title:r.formatMessage({id:"key0017",defaultMessage:"查看日志"}),children:e.jsx(c,{type:"text",onClick:()=>{n(u)},children:e.jsx(ue,{})})}),e.jsx(o,{title:r.formatMessage({id:"key0018",defaultMessage:"清除日志"}),children:e.jsx(c,{type:"text",onClick:()=>{k(`${m}/${u}/logs`,"DELETE").then(()=>g())},children:e.jsx(oe,{})})}),e.jsx(o,{title:r.formatMessage({id:"key0001",defaultMessage:"打开目录"}),children:e.jsx(c,{type:"text",onClick:()=>{k(`/system/run?command=${encodeURIComponent(`code.cmd ${i==null?void 0:i.path}`)}`,"GET")},children:e.jsx(me,{})})})]})]})};function be(){var U;const s=z(),{data:i,isLoading:u,mutate:j}=v(m),{data:n,mutate:f}=v(`${m}/runningInfos`,{refreshInterval:2e3}),[l,g]=y.useState(null),{data:r,mutate:R}=v(l!==null?`${m}/${l}/logs`:void 0,l!==null?{fetcher:_,refreshInterval:2e3,revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0}:{}),[G,M]=y.useMemo(()=>{const t=[];let a=1;const d=[];let b=0;return r==null||r.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,($,Y,Z,H,A,D)=>{d.push(r.slice(b,D)),b=D+$.length;const F=`error${a++}`;return t.push(F),A?(d.push(e.jsx("span",{id:F,className:"text-red-500",children:A},F)),$):(d.push(e.jsx("h3",{id:F,className:"text-red-500",children:e.jsx(c,{type:"link",onClick:()=>{k(`/system/run?command=${encodeURIComponent(`code.cmd ${Y}:${Z}:${H}`)}`,"GET")},target:"_blank",children:$})})),$)}),r&&d.push(r.slice(b)),[d,t]},[r]),O=y.useRef(0),T=t=>{l==null&&g(t),!(!M||M.length===0)&&(window.location.href=`#${M==null?void 0:M[O.current]}`,O.current=(O.current+1)%M.length)},[J,C]=y.useState(!1),[x]=h.useForm(),B=ge(h.useWatch("path",x)),{data:V}=I(B?`${xe}/system/read?path=${encodeURIComponent(`${B}/package.json`)}`:void 0,_),{data:w}=v(pe),Q=he(),X=t=>e.jsx(L,{rowKey:"id",columns:Q,dataSource:t.appProcessStatuses,pagination:!1}),{data:E}=v(`${m}/paths`);return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-center items-center h-8",children:[e.jsx("h2",{className:"mr-auto",children:e.jsx(ee,{id:"key0019",defaultMessage:"服务管理"})}),e.jsx(o,{title:s.formatMessage({id:"key0062",defaultMessage:"添加服务"}),placement:"leftBottom",children:e.jsx(c,{type:"text",onClick:()=>{x.resetFields(),C(!0)},children:e.jsx(se,{})})})]}),e.jsx(L,{rowKey:"id",pagination:!1,dataSource:i,loading:u,expandable:{expandedRowRender:X,defaultExpandAllRows:!1},columns:[{title:s.formatMessage({id:"key0020",defaultMessage:"描述"}),dataIndex:"description",render:(t,a)=>e.jsx("div",{children:e.jsx("div",{children:e.jsx(q,{logInfo:n==null?void 0:n[a.id],processesId:a.id,process:a,processesName:a.description,onClick:()=>T(a.id),setProcessesId:g,refetchServerInfo:f,refetchLog:R})})})},{title:s.formatMessage({id:"key0021",defaultMessage:"命令"}),dataIndex:"command"},{dataIndex:"path",title:s.formatMessage({id:"key0023",defaultMessage:"地址"})},{title:p.intl.formatMessage({id:"key0024",defaultMessage:"操作"}),render:(t,a)=>e.jsxs("div",{children:[e.jsx(o,{title:p.intl.formatMessage({id:"key0025",defaultMessage:"删除服务"}),children:e.jsx(c,{type:"text",onClick:()=>{S.confirm({title:p.intl.formatMessage({id:"key0026",defaultMessage:"是否删除服务?"}),icon:e.jsx(te,{}),onOk(){k(`${m}/${a.id}`,"DELETE").then(()=>{P.success(p.intl.formatMessage({id:"key0027",defaultMessage:"删除成功"})),j()})}})},children:e.jsx(ae,{})})}),e.jsx(o,{title:p.intl.formatMessage({id:"key0028",defaultMessage:"编辑服务"}),children:e.jsx(c,{type:"text",onClick:()=>{var d;x.setFieldsValue({...a,appProcessStatusIds:(d=a.appProcessStatuses)==null?void 0:d.map(b=>b.id)}),C(!0)},children:e.jsx(ie,{})})})]})}]}),e.jsx(S,{open:l!==null&&n!==void 0,onCancel:()=>g(null),footer:null,title:e.jsx("div",{className:"space-x-5 flex align-middle",children:l!==null&&e.jsx(q,{logInfo:n==null?void 0:n[l],processesId:l,refetchLog:R,process:i==null?void 0:i.find(t=>t.id===l),processesName:(U=i==null?void 0:i.find(t=>t.id===l))==null?void 0:U.description,onClick:()=>T(l),setProcessesId:g,refetchServerInfo:f})}),width:"80vw",classNames:{body:fe`
            height: 80vh;
            overflow-y: scroll;
          `},centered:!0,children:e.jsx("pre",{children:G})}),e.jsxs(S,{open:J,title:x.getFieldValue("id")===void 0?s.formatMessage({id:"key0041",defaultMessage:"新建服务"}):s.formatMessage({id:"key0028",defaultMessage:"编辑服务"}),okButtonProps:{autoFocus:!0,htmlType:"submit"},onCancel:()=>C(!1),destroyOnClose:!0,modalRender:t=>e.jsx(h,{layout:"vertical",form:x,name:"form_in_modal",onFinish:a=>{const d=x.getFieldValue("id");k(m,d!==void 0?"PUT":"POST",{...a,id:d,projectId:x.getFieldValue("projectId")}).then(()=>{P.success(s.formatMessage({id:"key0037",defaultMessage:"操作成功"})),j(),C(!1)})},children:t}),children:[e.jsx(h.Item,{name:"path",label:s.formatMessage({id:"key0063",defaultMessage:"路径"}),normalize:t=>{var a;return(a=t==null?void 0:t.trim())==null?void 0:a.replace(/[\\/]+/g,"/")},rules:[{required:!0,message:s.formatMessage({id:"key0064",defaultMessage:"路径不能为空"})}],children:e.jsx(K,{options:(E==null?void 0:E.map(t=>({label:t,value:t})))??[]})}),e.jsx(h.Item,{name:"command",label:s.formatMessage({id:"key0021",defaultMessage:"命令"}),rules:[{required:!0,message:s.formatMessage({id:"key0042",defaultMessage:"命令不能为空"})}],children:e.jsx(K,{options:V?Object.keys(Me(V).scripts??{}).reduce((t,a)=>(t.push({label:a,value:`npm run ${a}`}),t),[]):[]})}),e.jsx(h.Item,{name:"description",label:s.formatMessage({id:"key0040",defaultMessage:"名称或描述"}),children:e.jsx(re,{})}),e.jsx(h.Item,{name:"appProcessStatusIds",label:s.formatMessage({id:"key0065",defaultMessage:"日志状态配置"}),children:e.jsx(le,{mode:"multiple",options:w==null?void 0:w.map(t=>({label:e.jsx("span",{style:{color:t.color},children:t.name}),value:t.id}))})})]})]})}export{be as default};
