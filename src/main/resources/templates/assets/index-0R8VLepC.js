import{u as oe,j as e,C as Y,B as v,S as O,r as j,F as y,I as k,a as Z,s as w,b as me,M as b,E as fe,T as L,P as ee,c as ve,d as te,D as xe,e as ge,f as je,R as Se,g as Re,h as Ce,i as ye,k as Ee,L as se,l as Pe,m as we,n as re,N as Ie}from"./vendor-bv2W42_R.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))c(l);new MutationObserver(l=>{for(const a of l)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&c(n)}).observe(document,{childList:!0,subtree:!0});function i(l){const a={};return l.integrity&&(a.integrity=l.integrity),l.referrerPolicy&&(a.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?a.credentials="include":l.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(l){if(l.ep)return;l.ep=!0;const a=i(l);fetch(l.href,a)}})();const Ne="modulepreload",Oe=function(t){return"/"+t},ne={},B=function(o,i,c){let l=Promise.resolve();if(i&&i.length>0){const a=document.getElementsByTagName("link");l=Promise.all(i.map(n=>{if(n=Oe(n),n in ne)return;ne[n]=!0;const f=n.endsWith(".css"),x=f?'[rel="stylesheet"]':"";if(!!c)for(let P=a.length-1;P>=0;P--){const S=a[P];if(S.href===n&&(!f||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${x}`))return;const R=document.createElement("link");if(R.rel=f?"stylesheet":Ne,f||(R.as="script",R.crossOrigin=""),R.href=n,document.head.appendChild(R),f)return new Promise((P,S)=>{R.addEventListener("load",P),R.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${n}`)))})}))}return l.then(()=>o()).catch(a=>{const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a})},q="http://localhost:9981",ae=()=>oe(`${q}/api/npmProjects`),ke=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function be({rootNodeServerStates:t,updateRootNodeServerStates:o,nodeServerState:i}){const[c,l]=j.useState(),{data:a}=ae(),[n]=y.useForm();return j.useEffect(()=>{i.form=n},[i,n]),e.jsxs(y,{form:n,layout:"horizontal",initialValues:i,children:[e.jsx(y.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(k,{})}),e.jsx(y.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(k,{})}),e.jsx(y.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(Z,{value:c,onChange:l,children:a==null?void 0:a.map(f=>e.jsx(Z.Option,{value:f.id,children:f.path},f.id))})}),e.jsx(y.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(k,{})}),e.jsx(y.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(f,x)=>{try{return new RegExp(String(x)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(k,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(y.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(ie,{nodeServerStates:i.postServers??[],prevNodeServerState:i,rootNodeServerStates:t,updateRootNodeServerStates:o})})})]})}let Le=0;function ie({rootNodeServerStates:t,updateRootNodeServerStates:o,nodeServerStates:i,prevNodeServerState:c}){const l=()=>{let a=[...i],n=c;for(;n;){n.postServers=a;const f=n.prevServer,x=(f==null?void 0:f.postServers)??t;x[x.indexOf(n)]={...n},a=[...x],n=f}o(a)};return e.jsxs(Y,{children:[i.map((a,n)=>e.jsxs(Y,{className:"cm1s535",children:[e.jsx(be,{nodeServerState:a,updateRootNodeServerStates:o,rootNodeServerStates:t},a.id??a.tmpId),e.jsx(v,{onClick:()=>{i.splice(n,1),l()},children:"删除服务"})]})),e.jsx(O,{className:"c1lck55g",children:ke.map(a=>e.jsxs(v,{type:"primary",onClick:()=>{i.push({...a.value,tmpId:`tmp${Le++}`,prevServer:c}),l()},children:[a.name,"模板"]}))})]})}var E=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(E||{});function Te(t,o=500){const[i,c]=j.useState(t);return j.useLayoutEffect(()=>{const l=window.setTimeout(()=>c(t),o);return()=>window.clearTimeout(l)},[t,o]),i}function Fe({value:t,onChange:o,...i}){const[c,l]=j.useState(t),a=Te(c);return j.useEffect(()=>{o(a)},[o,a]),e.jsx(k,{...i,value:c,onChange:n=>{var f;l((f=n.target.value)==null?void 0:f.trim())}})}const Me="http://localhost:9981",C=async(t,o,i)=>{try{const c=await window.fetch(`${Me}${t}`,{method:o,...i&&{body:typeof i=="string"?i:JSON.stringify(i)},headers:{"Content-Type":"application/json"}}),l=await c.json();if(c.status!==200)throw new Error(l==null?void 0:l.data);return l.data}catch(c){throw w.error(c==null?void 0:c.message),c}};function _e({nodes:t,rawLogs:o}){return console.log(`refresh${o}`),e.jsx("div",{className:"c19i87wg",children:t})}function $e(){var z,H,J,Q;const{data:t,mutate:o}=ae(),[i,c]=j.useState([]),{nodeIdMapNodeServerResponse:l,rootNodeServerResponses:a}=j.useMemo(()=>{const r={},s={},d=[],u=[];return t==null||t.forEach(h=>{h.nodeServers.forEach(m=>{const p={...m};p.portConfigFileRelativePath=decodeURIComponent(p.portConfigFileRelativePath),p.portReg=decodeURIComponent(p.portReg);const g={...p,postServers:[]};r[p.id]=g,s[p.id]=p,p.prevServerId||(u.push(p),d.push(g))})}),Object.values(r).forEach(h=>{var p;const m=h;m.prevServer=m.prevServerId?r[m.prevServerId]:void 0,m.postServers=((p=m.postServerIds)==null?void 0:p.map(g=>r[g]))??[]}),c(d),{rootNodeServerResponses:u,nodeIdMapNodeServerResponse:s}},[t]),[n,f]=j.useState(null),[x,T]=j.useState(!1),[R,P]=j.useState({}),{data:S,mutate:G}=oe(`${q}/api/nodeServers/runningInfos`,{revalidateIfStale:!1,revalidateOnMount:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1,onSuccess:async r=>{const s=Object.keys(r),d=await Promise.all(s.map(h=>fetch(`${q}/api/nodeServers/logs/${h}`,{method:"GET"}).then(m=>{var p,g;return(g=(p=m.body)==null?void 0:p.getReader())==null?void 0:g.read()}).then(m=>{const p=[];let g="";if(m!=null&&m.value){g=new TextDecoder().decode(m.value);let U=0;g.replace(/ERROR in ([^(]+)\((\d+),(\d+)\)/g,(D,ue,pe,he,X)=>(p.push(g.slice(U,X)),U=X+D.length,p.push(e.jsx(v,{className:"c5s1knt",type:"link",onClick:()=>{C("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${ue}:${pe}:${he}`))},target:"_blank",children:D})),D)),p.push(g.slice(U))}return[p,g]}))),u={};d.forEach((h,m)=>{const p=s[m];u[p]={rawLogs:h[1],nodes:h[0]}}),P(u)},...!x&&{refreshInterval:1e3}});console.log(S);const F=(r,s)=>C(`/api/nodeServers/${r}/${s}`,"PUT").then(()=>{w.success(`${r}指令已发送`)}),K=(r,s)=>{var h,m;let d="",u="processing";if(!S||r===void 0||r===null||((h=S[r])==null?void 0:h.status)===void 0)d="未开启",u="grey";else{const p=(m=S[r])==null?void 0:m.status;switch(p){case E.CLOSED:d="已关闭",u="grey";break;case E.ERROR:d="错误",u="error";break;case E.COMPILING:d="编译中..",u="processing";break;case E.SUCCESS:d="成功",u="success";break;case E.UNKNOWN:d="未知",u="warning";break;default:{const g=p;throw new Error(g)}}}return e.jsxs(O,{className:"cg3n9dw",children:[e.jsx("div",{children:s??""}),e.jsx(ve,{bordered:!1,color:u,children:d})]})},M=[{title:"名称",dataIndex:"name",render:(r,s)=>K(s.id,s.name)},{title:"命令",dataIndex:"command"},{title:"地址",render:(r,s)=>{var u;const d=(u=t==null?void 0:t.find(h=>h.id===s.npmProjectId))==null?void 0:u.path;return s.errorField==="PROJECT_PATH"?e.jsx(te,{title:s.errorMsg,children:e.jsx("span",{className:"c1cph1bk",children:d})}):d}},{title:"端口",dataIndex:"port",render:(r,s)=>{if(s.errorMsg)return e.jsx(te,{title:s.errorMsg,children:e.jsx("span",{className:"c1oriuqi",children:s.errorMsg})});const d=Object.values(l).find(u=>u.id!==s.id&&u.port===r);return e.jsx(Fe,{value:r,style:d?{color:"red"}:{},onChange:u=>{String(u)!==String(r)&&C(`/api/nodeServers/changePort/${s.id}/${u}`,"PUT").then(o)}})}},{title:"操作",render:(r,s)=>{const d=S?S[s.id]:null;return e.jsxs(O,{children:[x&&e.jsx(ee,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{C(`/api/nodeServers/${s.id}`,"DELETE").then(()=>{w.success("删除成功"),o()})},children:e.jsx(v,{type:"link",children:"删除"})}),!x&&e.jsxs(xe,{disabled:!!s.errorMsg,children:[e.jsx(v,{type:"link",onClick:()=>C(`/api/npmProjects/vscode/${s.npmProjectId}`,"GET"),children:"vscode"}),(!d||d.status===E.CLOSED)&&e.jsx(v,{type:"link",onClick:()=>F("start",s.id).then(()=>{G()}),children:"启动"}),d&&e.jsxs(e.Fragment,{children:[e.jsx(v,{type:"link",onClick:()=>f(s.id??null),children:"日志"}),e.jsx(v,{type:"link",onClick:()=>F("restart",s.id).then(()=>{G()}),children:"重启"}),d.status!==E.CLOSED&&e.jsx(v,{type:"link",onClick:()=>F("stop",s.id),children:"关闭"})]})]})]})}}],le=r=>{var s;return e.jsx(L,{pagination:!1,dataSource:((s=r.nodeServers)==null?void 0:s.map(d=>({...d,key:d.id})))??[],rowKey:"id",columns:M})};function A(r){const{postServerIds:s}=r;if(!s||s.length===0)return null;const d=s.map(u=>({...l[u],key:u}));return e.jsx(L,{pagination:!1,dataSource:d,columns:M,...s.length>0&&{expandable:{expandedRowRender:A,defaultExpandedRowKeys:s}}})}const[ce,I]=j.useState(!1),[_,W]=j.useState(),[N]=y.useForm(),[de,$]=j.useState(!1);return e.jsxs("div",{children:[e.jsxs(O,{className:"c4u9m77",children:[e.jsx(me,{options:["项目分组","服务分组"],defaultValue:x?"项目分组":"服务分组",onChange:r=>{T(r==="项目分组")}}),x&&e.jsxs(e.Fragment,{children:[e.jsx(v,{onClick:()=>{I(!0),N.resetFields()},type:"primary",children:"添加项目"}),e.jsx(v,{onClick:()=>{$(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(v,{onClick:()=>{b.confirm({title:"是否关闭控制台？",icon:e.jsx(fe,{}),content:"关闭后台运行进程",onOk(){C("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!x&&a.length>0&&e.jsx(L,{pagination:!1,dataSource:a.map(r=>({...r,key:r.id})),columns:M,expandable:{expandedRowRender:A,defaultExpandedRowKeys:a.map(r=>r.id)}}),x&&(t!=null&&t.length)?e.jsx(L,{pagination:!1,dataSource:t.map(r=>({...r,key:r.id})),expandable:{expandedRowRender:le,defaultExpandedRowKeys:t==null?void 0:t.map(r=>r.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(r,s)=>e.jsxs(O,{children:[e.jsx(ee,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{C(`/api/npmProjects/${s.id}`,"DELETE").then(()=>{w.success("删除成功"),o()})},children:e.jsx(v,{type:"link",children:"删除"})}),e.jsx(v,{type:"primary",onClick:()=>{W(s),I(!0),N.setFieldValue("path",s.path)},children:"编辑"}),e.jsx(v,{type:"primary",onClick:()=>{W(s),I(!0),N.setFieldValue("path",s.path)},children:"添加服务"})]})}]}):null,e.jsx(b,{open:ce,title:`${_?"编辑":"添加"}项目`,onCancel:()=>I(!1),onOk:()=>{N.validateFields().then(r=>{if(N.resetFields(),_){C("/api/npmProjects","PUT",{path:r.path,id:_.id}).then(()=>{o(),I(!1),w.success("修改项目成功")});return}C("/api/npmProjects","POST",r).then(()=>{o(),I(!1),w.success("创建项目成功")})})},children:e.jsx(y,{form:N,layout:"vertical",name:"path",children:e.jsx(y.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(k,{})})})}),e.jsx(b,{title:"编辑或添加服务",open:de,onCancel:()=>{$(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const r=d=>d.map(u=>{var m;const h={...(m=u.form)==null?void 0:m.getFieldsValue(!0)};return h.postServers??(h.postServers=[]),h.portConfigFileRelativePath=encodeURIComponent(h.portConfigFileRelativePath),h.portReg=encodeURIComponent(h.portReg),h.postServers=r(u.postServers),h}),s=r(i);C("/api/nodeServers/batch","POST",s).then(()=>{w.success("保存服务成功"),o(),$(!1)})},width:"80vw",children:e.jsx(ie,{nodeServerStates:i,rootNodeServerStates:i,updateRootNodeServerStates:c})}),e.jsx(b,{open:n!==null,onCancel:()=>f(null),footer:null,title:e.jsxs(O,{className:"c1ru92bi",children:[K(n,n?(z=l[n])==null?void 0:z.name:""),e.jsx(v,{type:"link",onClick:()=>C(`/api/nodeServers/clearLog/${n}`,"GET"),children:"清除日志"})]}),width:"80vw",classNames:{body:"bckpddg"},centered:!0,children:n&&S&&e.jsx(_e,{rawLogs:(H=R[n])==null?void 0:H.rawLogs,nodes:(J=R[n])==null?void 0:J.nodes},(Q=R[n])==null?void 0:Q.rawLogs)})]})}const Ue=t=>fetch(t).then(o=>o.json().then(i=>i.data));function De(t){switch(t){case"en-US":return B(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(o=>o.default);case"zh-CN":return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(o=>o.default);default:return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(o=>o.default)}}const V=ge()(t=>({setLocale:async o=>{const i=await De(o);t({locale:o,messages:i})}})),Be=()=>{const t=V(c=>c.locale),o=V(c=>c.messages),i=V(c=>c.setLocale);return j.useLayoutEffect(()=>{t||i("zh-CN")},[t,i]),!o||!t?null:e.jsx(Ce,{locale:t,messages:o,children:e.jsx(ye,{value:{fetcher:Ue,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(Ee,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(se,{style:{minHeight:"100vh"},children:e.jsx(se,{children:e.jsx(Pe,{children:e.jsxs(we,{children:[e.jsx(re,{path:"/nodeServerManagement",element:e.jsx($e,{})}),e.jsx(re,{path:"*",element:e.jsx(Ie,{to:"/nodeServerManagement"})})]})})})})})})})};je(document.getElementById("root")).render(e.jsx(Se.StrictMode,{children:e.jsx(Re,{children:e.jsx(Be,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
