import{r as R,j as t,n as p,i as T,k as K,o as F,T as C,p as B,q as G,t as W,v as A,w as q,s as z}from"./vendor-7SbI7Aem.js";import{u as k,j as $,c as o,a as H}from"./types-lAkVZ-oF.js";var l=(e=>(e.CLOSED="CLOSED",e.COMPILING="COMPILING",e.ERROR="ERROR",e.SUCCESS="SUCCESS",e.UNKNOWN="UNKNOWN",e))(l||{});const b=(e,i)=>$(`${o}/${e}/${i}`,"PUT").then(()=>{z.success(`${e}指令已发送`)}),U=({logInfo:e,nodeServerId:i,nodeServerName:a,setNodeServerId:N,refetchServerInfo:s,onClick:x,refetchLog:n})=>{let r="",c="processing";if((e==null?void 0:e.status)===void 0)r="未开启",c="grey";else{const{status:d}=e;switch(d){case l.CLOSED:r="已关闭",c="grey";break;case l.ERROR:r="错误",c="error";break;case l.COMPILING:r="编译中..",c="processing";break;case l.SUCCESS:r="成功",c="success";break;case l.UNKNOWN:r="未知",c="warning";break;default:{const j=d;throw new Error(j)}}}return t.jsxs("div",{children:[t.jsxs("div",{className:"flex space-x-2 items-center",children:[t.jsx("div",{children:a??""}),t.jsx(F,{bordered:!1,color:c,className:"flex align-middle cursor-pointer",onClick:x,children:r})]}),t.jsxs("div",{className:" text-grey mt-2",children:[t.jsx(C,{title:"启动服务",children:t.jsx(p,{type:"text",disabled:(e==null?void 0:e.status)!==l.CLOSED&&(e==null?void 0:e.status)!==void 0,onClick:()=>{b("start",i).then(()=>s())},className:"text-green-600 cursor-pointer",children:t.jsx(B,{})})}),t.jsx(C,{title:"关闭服务",children:t.jsx(p,{type:"text",disabled:(e==null?void 0:e.status)===l.CLOSED||(e==null?void 0:e.status)===void 0,onClick:()=>{b("stop",i).then(()=>s())},className:"text-red-500 cursor-pointer",children:t.jsx(G,{})})}),t.jsx(C,{title:"重启服务",children:t.jsx(p,{type:"text",onClick:()=>{b("restart",i).then(()=>s())},disabled:(e==null?void 0:e.status)===l.CLOSED||(e==null?void 0:e.status)===void 0,className:"text-green-600 cursor-pointer",children:t.jsx(W,{})})}),t.jsx(C,{title:"查看日志",children:t.jsx(p,{type:"text",onClick:()=>{N(i)},children:t.jsx(A,{})})}),t.jsx(C,{title:"清除日志",children:t.jsx(p,{type:"text",onClick:()=>{$(`${o}/logs/${i}`,"DELETE").then(()=>n())},children:t.jsx(q,{})})})]})]})};function V(){var L;const{data:e,isLoading:i}=k(o),{data:a,mutate:N}=k(`${o}/runningInfos`,{refreshInterval:2e3}),[s,x]=R.useState(null),{data:n,mutate:r}=k(s!==null?`${o}/logs/${s}`:void 0,s!==null?{fetcher:H,refreshInterval:2e3,revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0}:{}),[c,d]=R.useMemo(()=>{const u=[];let h=1;const m=[];let E=0;return n==null||n.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(O,P,D,M,S,w)=>{m.push(n.slice(E,w)),E=w+O.length;const v=`error${h++}`;return u.push(v),S?(m.push(t.jsx("h3",{id:v,className:"text-red-500",children:S},v)),O):(m.push(t.jsx("h3",{id:v,className:"text-red-500",children:t.jsx(p,{type:"link",onClick:()=>{$("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${P}:${D}:${M}`))},target:"_blank",children:O})})),O)}),n&&m.push(n.slice(E)),[m,u]},[n]),j=R.useRef(0),y=u=>{s==null&&x(u),!(!d||d.length===0)&&(window.location.href=`#${d==null?void 0:d[j.current]}`,j.current=(j.current+1)%d.length)};return t.jsxs("div",{children:[t.jsx("div",{className:"flex justify-center items-center h-8",children:t.jsx("h2",{className:"mr-auto",children:"服务管理"})}),t.jsx(T,{rowKey:"id",pagination:!1,dataSource:e,loading:i,columns:[{title:"描述",dataIndex:"description",render:(u,h)=>t.jsx("div",{children:t.jsx("div",{children:t.jsx(U,{logInfo:a==null?void 0:a[h.id],nodeServerId:h.id,nodeServerName:h.description,onClick:()=>y(h.id),setNodeServerId:x,refetchServerInfo:N,refetchLog:r})})})},{title:"命令",dataIndex:"command"},{title:"端口",dataIndex:"port"},{dataIndex:["npmProject","path"],title:"地址"}]}),t.jsx(K,{open:s!==null&&a!==void 0,onCancel:()=>x(null),footer:null,title:t.jsx("div",{className:"space-x-5 flex align-middle",children:s!==null&&t.jsx(U,{logInfo:a==null?void 0:a[s],nodeServerId:s,refetchLog:r,nodeServerName:(L=e==null?void 0:e.find(u=>u.id===s))==null?void 0:L.description,onClick:()=>y(s),setNodeServerId:x,refetchServerInfo:N})}),width:"80vw",classNames:{body:"b10u8ylt"},centered:!0,children:t.jsx("pre",{children:c})})]})}export{V as default};
