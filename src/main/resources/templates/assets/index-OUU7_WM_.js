import{u as q,j as e,C as X,B as x,S as k,r as f,F as R,I,a as Y,s as E,b as ue,M,E as pe,T as L,P as Z,c as me,d as A,D as he,e as fe,f as ve,R as xe,g as ge,h as je,i as Se,k as Re,L as ee,l as Ce,m as ye,n as te,N as Ee}from"./vendor-bv2W42_R.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))l(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&l(r)}).observe(document,{childList:!0,subtree:!0});function c(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(o){if(o.ep)return;o.ep=!0;const s=c(o);fetch(o.href,s)}})();const Ne="modulepreload",Pe=function(t){return"/"+t},ne={},B=function(n,c,l){let o=Promise.resolve();if(c&&c.length>0){const s=document.getElementsByTagName("link");o=Promise.all(c.map(r=>{if(r=Pe(r),r in ne)return;ne[r]=!0;const d=r.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(!!l)for(let y=s.length-1;y>=0;y--){const C=s[y];if(C.href===r&&(!d||C.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${h}`))return;const v=document.createElement("link");if(v.rel=d?"stylesheet":Ne,d||(v.as="script",v.crossOrigin=""),v.href=r,document.head.appendChild(v),d)return new Promise((y,C)=>{v.addEventListener("load",y),v.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${r}`)))})}))}return o.then(()=>n()).catch(s=>{const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s})},K="http://localhost:9981",ae=()=>q(`${K}/api/npmProjects`,{revalidateIfStale:!1,revalidateOnMount:!0,revalidateOnFocus:!1,revalidateOnReconnect:!1}),we=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function Oe({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerState:c}){const[l,o]=f.useState(),{data:s}=ae(),[r]=R.useForm();return f.useEffect(()=>{c.form=r},[c,r]),e.jsxs(R,{form:r,layout:"horizontal",initialValues:c,children:[e.jsx(R.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(I,{})}),e.jsx(R.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(I,{})}),e.jsx(R.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(Y,{value:l,onChange:o,children:s==null?void 0:s.map(d=>e.jsx(Y.Option,{value:d.id,children:d.path},d.id))})}),e.jsx(R.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(I,{})}),e.jsx(R.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(d,h)=>{try{return new RegExp(String(h)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(I,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(R.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(oe,{nodeServerStates:c.postServers??[],prevNodeServerState:c,rootNodeServerStates:t,updateRootNodeServerStates:n})})})]})}let ke=0;function oe({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerStates:c,prevNodeServerState:l}){const o=()=>{let s=[...c],r=l;for(;r;){r.postServers=s;const d=r.prevServer,h=(d==null?void 0:d.postServers)??t;h[h.indexOf(r)]={...r},s=[...h],r=d}n(s)};return e.jsxs(X,{children:[c.map((s,r)=>e.jsxs(X,{className:"cm1s535",children:[e.jsx(Oe,{nodeServerState:s,updateRootNodeServerStates:n,rootNodeServerStates:t},s.id??s.tmpId),e.jsx(x,{onClick:()=>{c.splice(r,1),o()},children:"删除服务"})]})),e.jsx(k,{className:"c1lck55g",children:we.map(s=>e.jsxs(x,{type:"primary",onClick:()=>{c.push({...s.value,tmpId:`tmp${ke++}`,prevServer:l}),o()},children:[s.name,"模板"]}))})]})}var b=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(b||{});function be(t,n=500){const[c,l]=f.useState(t);return f.useLayoutEffect(()=>{const o=window.setTimeout(()=>l(t),n);return()=>window.clearTimeout(o)},[t,n]),c}function Ie({value:t,onChange:n,...c}){const[l,o]=f.useState(t),s=be(l);return f.useEffect(()=>{n(s)},[n,s]),e.jsx(I,{...c,value:l,onChange:r=>{var d;o((d=r.target.value)==null?void 0:d.trim())}})}const Fe="http://localhost:9981",S=async(t,n,c)=>{try{const l=await window.fetch(`${Fe}${t}`,{method:n,...c&&{body:typeof c=="string"?c:JSON.stringify(c)},headers:{"Content-Type":"application/json"}}),o=await l.json();if(l.status!==200)throw new Error(o==null?void 0:o.data);return o.data}catch(l){throw E.error(l==null?void 0:l.message),l}},Te=t=>fetch(t,{method:"GET"}).then(n=>n.text()).then(n=>n.replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,"").replace(/(\x00)+/g,`
`)),se="e19i87wg",re=({nodeServerInfo:t,nodeServerId:n,nodeServerName:c,errorAnchorIds:l})=>{var d,h;let o="",s="processing";const r=f.useRef(0);if(!t||n===void 0||n===null||((d=t[n])==null?void 0:d.status)===void 0)o="未开启",s="grey";else{const N=(h=t[n])==null?void 0:h.status;switch(N){case b.CLOSED:o="已关闭",s="grey";break;case b.ERROR:o="错误",s="error";break;case b.COMPILING:o="编译中..",s="processing";break;case b.SUCCESS:o="成功",s="success";break;case b.UNKNOWN:o="未知",s="warning";break;default:{const v=N;throw new Error(v)}}}return e.jsxs(e.Fragment,{children:[e.jsx("div",{children:c??""}),e.jsx(me,{bordered:!1,color:s,style:l!=null&&l.length&&(l==null?void 0:l.length)>0?{cursor:"pointer"}:{},onClick:()=>{l&&(window.location.href=`#${l==null?void 0:l[r.current]}`,r.current=(r.current+1)%l.length)},children:o})]})};function Me(){var H;const{data:t,mutate:n}=ae(),[c,l]=f.useState([]),{nodeIdMapNodeServerResponse:o,rootNodeServerResponses:s}=f.useMemo(()=>{const i={},a={},u=[],p=[];return t==null||t.forEach(m=>{m.nodeServers.forEach(j=>{const g={...j};g.portConfigFileRelativePath=decodeURIComponent(g.portConfigFileRelativePath),g.portReg=decodeURIComponent(g.portReg);const O={...g,postServers:[]};i[g.id]=O,a[g.id]=g,g.prevServerId||(p.push(g),u.push(O))})}),Object.values(i).forEach(m=>{var g;const j=m;j.prevServer=j.prevServerId?i[j.prevServerId]:void 0,j.postServers=((g=j.postServerIds)==null?void 0:g.map(O=>i[O]))??[]}),l(u),{rootNodeServerResponses:p,nodeIdMapNodeServerResponse:a}},[t]),[r,d]=f.useState(null),[h,N]=f.useState(!1),{data:v,mutate:y}=q(r?`${K}/api/nodeServers/logs/${r}`:void 0,Te,{...!r!==null&&{refreshInterval:2e3},revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0}),C=(i,a)=>S(`/api/nodeServers/${i}/${a}`,"PUT").then(()=>{E.success(`${i}指令已发送`)}),{data:F,mutate:T}=q(`${K}/api/nodeServers/runningInfos`,{...!h&&{refreshInterval:2e3}});f.useEffect(()=>{T()},[T]);const $=[{title:"名称",dataIndex:"name",render:(i,a)=>e.jsx(k,{className:"c5s1knt",children:e.jsx(re,{nodeServerInfo:F,nodeServerId:a.id,nodeServerName:a.name})})},{title:"命令",dataIndex:"command"},{title:"地址",render:(i,a)=>{var p;const u=(p=t==null?void 0:t.find(m=>m.id===a.npmProjectId))==null?void 0:p.path;return a.errorField==="PROJECT_PATH"?e.jsx(A,{title:a.errorMsg,children:e.jsx("span",{className:"cg3n9dw",children:u})}):u}},{title:"端口",dataIndex:"port",render:(i,a)=>{if(a.errorMsg)return e.jsx(A,{title:a.errorMsg,children:e.jsx("span",{className:"c1cph1bk",children:a.errorMsg})});const u=Object.values(o).find(p=>p.id!==a.id&&p.port===i);return e.jsx(Ie,{value:i,style:u?{color:"red"}:{},onChange:p=>{String(p)!==String(i)&&S(`/api/nodeServers/changePort/${a.id}/${p}`,"PUT").then(n)}})}},{title:"操作",render:(i,a)=>{const u=F?F[a.id]:null;return e.jsxs(k,{children:[h&&e.jsx(Z,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{S(`/api/nodeServers/${a.id}`,"DELETE").then(()=>{E.success("删除成功"),n()})},children:e.jsx(x,{type:"link",children:"删除"})}),!h&&e.jsxs(he,{disabled:!!a.errorMsg,children:[e.jsx(x,{type:"link",onClick:()=>S(`/api/npmProjects/vscode/${a.npmProjectId}`,"GET"),children:"vscode"}),e.jsx(x,{type:"link",onClick:()=>C("start",a.id).then(()=>T()),children:"启动"}),e.jsx(x,{type:"link",onClick:()=>{d(a.id??null)},disabled:!u,children:"日志"}),e.jsx(x,{type:"link",onClick:()=>C("restart",a.id).then(()=>T()),children:"重启"}),e.jsx(x,{type:"link",onClick:()=>C("stop",a.id),children:"关闭"})]})]})}}],le=i=>{var a;return e.jsx(L,{pagination:!1,dataSource:((a=i.nodeServers)==null?void 0:a.map(u=>({...u,key:u.id})))??[],rowKey:"id",columns:$})};function G(i){const{postServerIds:a}=i;if(!a||a.length===0)return null;const u=a.map(p=>({...o[p],key:p}));return e.jsx(L,{pagination:!1,dataSource:u,columns:$,...a.length>0&&{expandable:{expandedRowRender:G,defaultExpandedRowKeys:a}}})}const[ie,P]=f.useState(!1),[_,W]=f.useState(),[w]=R.useForm(),[ce,U]=f.useState(!1),[z,de]=f.useMemo(()=>{const i=[];let a=1;const u=[];let p=0;return console.log(v),v==null||v.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(m,j,g,O,J,Q)=>{u.push(v.slice(p,Q)),p=Q+m.length;const D=`error${a++}`;return i.push(D),J?(u.push(e.jsx("h3",{id:D,className:se,children:J})),m):(u.push(e.jsx("h3",{id:D,className:se,children:e.jsx(x,{type:"link",className:"c1oriuqi",onClick:()=>{S("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${j}:${g}:${O}`))},target:"_blank",children:m})})),m)}),[u,i]},[v]);return console.log(z),e.jsxs("div",{children:[e.jsxs(k,{className:"c4u9m77",children:[e.jsx(ue,{options:["项目分组","服务分组"],defaultValue:h?"项目分组":"服务分组",onChange:i=>{N(i==="项目分组")}}),h&&e.jsxs(e.Fragment,{children:[e.jsx(x,{onClick:()=>{P(!0),w.resetFields()},type:"primary",children:"添加项目"}),e.jsx(x,{onClick:()=>{U(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(x,{onClick:()=>{M.confirm({title:"是否关闭控制台？",icon:e.jsx(pe,{}),content:"关闭后台运行进程",onOk(){S("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!h&&s.length>0&&e.jsx(L,{pagination:!1,dataSource:s.map(i=>({...i,key:i.id})),columns:$,expandable:{expandedRowRender:G,defaultExpandedRowKeys:s.map(i=>i.id)}}),h&&(t!=null&&t.length)?e.jsx(L,{pagination:!1,dataSource:t.map(i=>({...i,key:i.id})),expandable:{expandedRowRender:le,defaultExpandedRowKeys:t==null?void 0:t.map(i=>i.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(i,a)=>e.jsxs(k,{children:[e.jsx(Z,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{S(`/api/npmProjects/${a.id}`,"DELETE").then(()=>{E.success("删除成功"),n()})},children:e.jsx(x,{type:"link",children:"删除"})}),e.jsx(x,{type:"primary",onClick:()=>{W(a),P(!0),w.setFieldValue("path",a.path)},children:"编辑"}),e.jsx(x,{type:"primary",onClick:()=>{W(a),P(!0),w.setFieldValue("path",a.path)},children:"添加服务"})]})}]}):null,e.jsx(M,{open:ie,title:`${_?"编辑":"添加"}项目`,onCancel:()=>P(!1),onOk:()=>{w.validateFields().then(i=>{if(w.resetFields(),_){S("/api/npmProjects","PUT",{path:i.path,id:_.id}).then(()=>{n(),P(!1),E.success("修改项目成功")});return}S("/api/npmProjects","POST",i).then(()=>{n(),P(!1),E.success("创建项目成功")})})},children:e.jsx(R,{form:w,layout:"vertical",name:"path",children:e.jsx(R.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(I,{})})})}),e.jsx(M,{title:"编辑或添加服务",open:ce,onCancel:()=>{U(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const i=u=>u.map(p=>{var j;const m={...(j=p.form)==null?void 0:j.getFieldsValue(!0)};return m.postServers??(m.postServers=[]),m.portConfigFileRelativePath=encodeURIComponent(m.portConfigFileRelativePath),m.portReg=encodeURIComponent(m.portReg),m.postServers=i(p.postServers),m}),a=i(c);S("/api/nodeServers/batch","POST",a).then(()=>{E.success("保存服务成功"),n(),U(!1)})},width:"80vw",children:e.jsx(oe,{nodeServerStates:c,rootNodeServerStates:c,updateRootNodeServerStates:l})}),e.jsx(M,{open:r!==null&&F!==void 0,onCancel:()=>d(null),footer:null,title:e.jsxs(k,{className:"c1ru92bi",children:[e.jsx(re,{nodeServerInfo:F,nodeServerId:r,nodeServerName:r?(H=o[r])==null?void 0:H.name:"",errorAnchorIds:de}),e.jsx(x,{type:"link",onClick:()=>S(`/api/nodeServers/clearLog/${r}`,"GET").then(()=>y()),children:"清除日志"})]}),width:"80vw",classNames:{body:"bckpddg"},centered:!0,children:e.jsx("div",{className:"cclyprh",children:z})})]})}const Le=t=>fetch(t).then(n=>n.json().then(c=>c.data));function $e(t){switch(t){case"en-US":return B(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(n=>n.default);case"zh-CN":return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default);default:return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default)}}const V=fe()(t=>({setLocale:async n=>{const c=await $e(n);t({locale:n,messages:c})}})),_e=()=>{const t=V(l=>l.locale),n=V(l=>l.messages),c=V(l=>l.setLocale);return f.useLayoutEffect(()=>{t||c("zh-CN")},[t,c]),!n||!t?null:e.jsx(je,{locale:t,messages:n,children:e.jsx(Se,{value:{fetcher:Le,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(Re,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(ee,{style:{minHeight:"100vh"},children:e.jsx(ee,{children:e.jsx(Ce,{children:e.jsxs(ye,{children:[e.jsx(te,{path:"/nodeServerManagement",element:e.jsx(Me,{})}),e.jsx(te,{path:"*",element:e.jsx(Ee,{to:"/nodeServerManagement"})})]})})})})})})})};ve(document.getElementById("root")).render(e.jsx(xe.StrictMode,{children:e.jsx(ge,{children:e.jsx(_e,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
