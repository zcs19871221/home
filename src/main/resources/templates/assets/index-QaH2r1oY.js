import{u as B,j as e,C as W,B as f,S as O,r as x,F as C,I as k,a as z,s as P,b as ne,M as b,E as oe,T as F,P as H,c as ae,d as J,D as ie,e as le,f as ce,R as de,g as ue,h as pe,i as me,k as he,L as Q,l as fe,m as ve,n as X,N as xe}from"./vendor-bv2W42_R.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))c(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function i(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(l){if(l.ep)return;l.ep=!0;const o=i(l);fetch(l.href,o)}})();const ge="modulepreload",je=function(t){return"/"+t},Y={},U=function(n,i,c){let l=Promise.resolve();if(i&&i.length>0){const o=document.getElementsByTagName("link");l=Promise.all(i.map(a=>{if(a=je(a),a in Y)return;Y[a]=!0;const p=a.endsWith(".css"),v=p?'[rel="stylesheet"]':"";if(!!c)for(let E=o.length-1;E>=0;E--){const S=o[E];if(S.href===a&&(!p||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${v}`))return;const j=document.createElement("link");if(j.rel=p?"stylesheet":ge,p||(j.as="script",j.crossOrigin=""),j.href=a,document.head.appendChild(j),p)return new Promise((E,S)=>{j.addEventListener("load",E),j.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${a}`)))})}))}return l.then(()=>n()).catch(o=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o})},V="http://localhost:9981",Z=()=>B(`${V}/api/npmProjects`),Se=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function Re({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerState:i}){const[c,l]=x.useState(),{data:o}=Z(),[a]=C.useForm();return x.useEffect(()=>{i.form=a},[i,a]),e.jsxs(C,{form:a,layout:"horizontal",initialValues:i,children:[e.jsx(C.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(k,{})}),e.jsx(C.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(k,{})}),e.jsx(C.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(z,{value:c,onChange:l,children:o==null?void 0:o.map(p=>e.jsx(z.Option,{value:p.id,children:p.path},p.id))})}),e.jsx(C.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(k,{})}),e.jsx(C.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(p,v)=>{try{return new RegExp(String(v)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(k,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(C.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(ee,{nodeServerStates:i.postServers??[],prevNodeServerState:i,rootNodeServerStates:t,updateRootNodeServerStates:n})})})]})}let Ce=0;function ee({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerStates:i,prevNodeServerState:c}){const l=()=>{let o=[...i],a=c;for(;a;){a.postServers=o;const p=a.prevServer,v=(p==null?void 0:p.postServers)??t;v[v.indexOf(a)]={...a},o=[...v],a=p}n(o)};return e.jsxs(W,{children:[i.map((o,a)=>e.jsxs(W,{className:"cm1s535",children:[e.jsx(Re,{nodeServerState:o,updateRootNodeServerStates:n,rootNodeServerStates:t},o.id??o.tmpId),e.jsx(f,{onClick:()=>{i.splice(a,1),l()},children:"删除服务"})]})),e.jsx(O,{className:"c1lck55g",children:Se.map(o=>e.jsxs(f,{type:"primary",onClick:()=>{i.push({...o.value,tmpId:`tmp${Ce++}`,prevServer:c}),l()},children:[o.name,"模板"]}))})]})}var y=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(y||{});function ye(t,n=500){const[i,c]=x.useState(t);return x.useLayoutEffect(()=>{const l=window.setTimeout(()=>c(t),n);return()=>window.clearTimeout(l)},[t,n]),i}function Ee({value:t,onChange:n,...i}){const[c,l]=x.useState(t),o=ye(c);return x.useEffect(()=>{n(o)},[n,o]),e.jsx(k,{...i,value:c,onChange:a=>{var p;l((p=a.target.value)==null?void 0:p.trim())}})}const Pe="http://localhost:9981",R=async(t,n,i)=>{try{const c=await window.fetch(`${Pe}${t}`,{method:n,...i&&{body:typeof i=="string"?i:JSON.stringify(i)},headers:{"Content-Type":"application/json"}}),l=await c.json();if(c.status!==200)throw new Error(l==null?void 0:l.data);return l.data}catch(c){throw P.error(c==null?void 0:c.message),c}};function Ie({rawLogs:t}){const n=[];let i=0;return t.replace(/ERROR in ([^(]+)\((\d+),(\d+)\)/g,(c,l,o,a,p)=>(n.push(t.slice(i,p)),i=p+c.length,n.push(e.jsx(f,{className:"c19i87wg",type:"link",onClick:()=>{R("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${l}:${o}:${a}`))},target:"_blank",children:c})),c)),n.push(t.slice(i)),e.jsx("pre",{className:"c5s1knt",children:n})}function Ne(){var G;const{data:t,mutate:n}=Z(),[i,c]=x.useState([]),{nodeIdMapNodeServerResponse:l,rootNodeServerResponses:o}=x.useMemo(()=>{const s={},r={},d=[],u=[];return t==null||t.forEach(m=>{m.nodeServers.forEach(g=>{const h={...g};h.portConfigFileRelativePath=decodeURIComponent(h.portConfigFileRelativePath),h.portReg=decodeURIComponent(h.portReg);const w={...h,postServers:[]};s[h.id]=w,r[h.id]=h,h.prevServerId||(u.push(h),d.push(w))})}),Object.values(s).forEach(m=>{var h;const g=m;g.prevServer=g.prevServerId?s[g.prevServerId]:void 0,g.postServers=((h=g.postServerIds)==null?void 0:h.map(w=>s[w]))??[]}),c(d),{rootNodeServerResponses:u,nodeIdMapNodeServerResponse:r}},[t]),[a,p]=x.useState(null),[v,T]=x.useState(!1),{data:j}=B(`${V}/api/nodeServers/logs`,{refreshInterval:5e3}),E=x.useMemo(()=>{const s={};let r=0;return new TextDecoder().decode(j).replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,"").replace(/__|id:(\d+)|__/g,(d,u,m)=>(s[Number(u)]=j.slice(r,m),r=m+d.length,"")),s},[j]),{data:S}=B(`${V}/api/nodeServers/runningInfos`,{revalidateIfStale:!1,revalidateOnMount:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1,...!v&&{refreshInterval:5e3}}),L=(s,r)=>R(`/api/nodeServers/${s}/${r}`,"PUT").then(()=>{P.success(`${s}指令已发送`)}),q=(s,r)=>{var m,g;let d="",u="processing";if(!S||s===void 0||s===null||((m=S[s])==null?void 0:m.status)===void 0)d="未开启",u="grey";else{const h=(g=S[s])==null?void 0:g.status;switch(h){case y.CLOSED:d="已关闭",u="grey";break;case y.ERROR:d="错误",u="error";break;case y.COMPILING:d="编译中..",u="processing";break;case y.SUCCESS:d="成功",u="success";break;case y.UNKNOWN:d="未知",u="warning";break;default:{const w=h;throw new Error(w)}}}return e.jsxs(O,{className:"cg3n9dw",children:[e.jsx("div",{children:r??""}),e.jsx(ae,{bordered:!1,color:u,children:d})]})},_=[{title:"名称",dataIndex:"name",render:(s,r)=>q(r.id,r.name)},{title:"命令",dataIndex:"command"},{title:"地址",render:(s,r)=>{var u;const d=(u=t==null?void 0:t.find(m=>m.id===r.npmProjectId))==null?void 0:u.path;return r.errorField==="PROJECT_PATH"?e.jsx(J,{title:r.errorMsg,children:e.jsx("span",{className:"c1cph1bk",children:d})}):d}},{title:"端口",dataIndex:"port",render:(s,r)=>{if(r.errorMsg)return e.jsx(J,{title:r.errorMsg,children:e.jsx("span",{className:"c1oriuqi",children:r.errorMsg})});const d=Object.values(l).find(u=>u.id!==r.id&&u.port===s);return e.jsx(Ee,{value:s,style:d?{color:"red"}:{},onChange:u=>{String(u)!==String(s)&&R(`/api/nodeServers/changePort/${r.id}/${u}`,"PUT").then(n)}})}},{title:"操作",render:(s,r)=>{const d=S?S[r.id]:null;return e.jsxs(O,{children:[v&&e.jsx(H,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{R(`/api/nodeServers/${r.id}`,"DELETE").then(()=>{P.success("删除成功"),n()})},children:e.jsx(f,{type:"link",children:"删除"})}),!v&&e.jsxs(ie,{disabled:!!r.errorMsg,children:[e.jsx(f,{type:"link",onClick:()=>R(`/api/npmProjects/vscode/${r.npmProjectId}`,"GET"),children:"vscode"}),(!d||d.status===y.CLOSED)&&e.jsx(f,{type:"link",onClick:()=>L("start",r.id),children:"启动"}),d&&e.jsxs(e.Fragment,{children:[e.jsx(f,{type:"link",onClick:()=>p(r.id??null),children:"日志"}),e.jsx(f,{type:"link",onClick:()=>L("restart",r.id),children:"重启"}),d.status!==y.CLOSED&&e.jsx(f,{type:"link",onClick:()=>L("stop",r.id),children:"关闭"})]})]})]})}}],te=s=>{var r;return e.jsx(F,{pagination:!1,dataSource:((r=s.nodeServers)==null?void 0:r.map(d=>({...d,key:d.id})))??[],rowKey:"id",columns:_})};function K(s){const{postServerIds:r}=s;if(!r||r.length===0)return null;const d=r.map(u=>({...l[u],key:u}));return e.jsx(F,{pagination:!1,dataSource:d,columns:_,...r.length>0&&{expandable:{expandedRowRender:K,defaultExpandedRowKeys:r}}})}const[re,I]=x.useState(!1),[M,A]=x.useState(),[N]=C.useForm(),[se,$]=x.useState(!1);return e.jsxs("div",{children:[e.jsxs(O,{className:"c4u9m77",children:[e.jsx(ne,{options:["项目分组","服务分组"],defaultValue:v?"项目分组":"服务分组",onChange:s=>{T(s==="项目分组")}}),v&&e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{I(!0),N.resetFields()},type:"primary",children:"添加项目"}),e.jsx(f,{onClick:()=>{$(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(f,{onClick:()=>{b.confirm({title:"是否关闭控制台？",icon:e.jsx(oe,{}),content:"关闭后台运行进程",onOk(){R("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!v&&o.length>0&&e.jsx(F,{pagination:!1,dataSource:o.map(s=>({...s,key:s.id})),columns:_,expandable:{expandedRowRender:K,defaultExpandedRowKeys:o.map(s=>s.id)}}),v&&(t!=null&&t.length)?e.jsx(F,{pagination:!1,dataSource:t.map(s=>({...s,key:s.id})),expandable:{expandedRowRender:te,defaultExpandedRowKeys:t==null?void 0:t.map(s=>s.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(s,r)=>e.jsxs(O,{children:[e.jsx(H,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{R(`/api/npmProjects/${r.id}`,"DELETE").then(()=>{P.success("删除成功"),n()})},children:e.jsx(f,{type:"link",children:"删除"})}),e.jsx(f,{type:"primary",onClick:()=>{A(r),I(!0),N.setFieldValue("path",r.path)},children:"编辑"}),e.jsx(f,{type:"primary",onClick:()=>{A(r),I(!0),N.setFieldValue("path",r.path)},children:"添加服务"})]})}]}):null,e.jsx(b,{open:re,title:`${M?"编辑":"添加"}项目`,onCancel:()=>I(!1),onOk:()=>{N.validateFields().then(s=>{if(N.resetFields(),M){R("/api/npmProjects","PUT",{path:s.path,id:M.id}).then(()=>{n(),I(!1),P.success("修改项目成功")});return}R("/api/npmProjects","POST",s).then(()=>{n(),I(!1),P.success("创建项目成功")})})},children:e.jsx(C,{form:N,layout:"vertical",name:"path",children:e.jsx(C.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(k,{})})})}),e.jsx(b,{title:"编辑或添加服务",open:se,onCancel:()=>{$(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const s=d=>d.map(u=>{var g;const m={...(g=u.form)==null?void 0:g.getFieldsValue(!0)};return m.postServers??(m.postServers=[]),m.portConfigFileRelativePath=encodeURIComponent(m.portConfigFileRelativePath),m.portReg=encodeURIComponent(m.portReg),m.postServers=s(u.postServers),m}),r=s(i);R("/api/nodeServers/batch","POST",r).then(()=>{P.success("保存服务成功"),n(),$(!1)})},width:"80vw",children:e.jsx(ee,{nodeServerStates:i,rootNodeServerStates:i,updateRootNodeServerStates:c})}),e.jsx(b,{open:a!==null&&S!==void 0,onCancel:()=>p(null),footer:null,title:e.jsxs(O,{className:"c1ru92bi",children:[q(a,a?(G=l[a])==null?void 0:G.name:""),e.jsx(f,{type:"link",onClick:()=>R(`/api/nodeServers/clearLog/${a}`,"GET"),children:"清除日志"})]}),width:"80vw",classNames:{body:"bckpddg"},centered:!0,children:e.jsx(Ie,{rawLogs:E[a??-1]??""})})]})}const we=t=>fetch(t).then(n=>n.json().then(i=>i.data));function Oe(t){switch(t){case"en-US":return U(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(n=>n.default);case"zh-CN":return U(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default);default:return U(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default)}}const D=le()(t=>({setLocale:async n=>{const i=await Oe(n);t({locale:n,messages:i})}})),ke=()=>{const t=D(c=>c.locale),n=D(c=>c.messages),i=D(c=>c.setLocale);return x.useLayoutEffect(()=>{t||i("zh-CN")},[t,i]),!n||!t?null:e.jsx(pe,{locale:t,messages:n,children:e.jsx(me,{value:{fetcher:we,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(he,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(Q,{style:{minHeight:"100vh"},children:e.jsx(Q,{children:e.jsx(fe,{children:e.jsxs(ve,{children:[e.jsx(X,{path:"/nodeServerManagement",element:e.jsx(Ne,{})}),e.jsx(X,{path:"*",element:e.jsx(xe,{to:"/nodeServerManagement"})})]})})})})})})})};ce(document.getElementById("root")).render(e.jsx(de.StrictMode,{children:e.jsx(ue,{children:e.jsx(ke,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
