import{u as Y,j as e,C as A,B as g,S as O,r as v,F as R,I as b,a as W,s as P,b as oe,M as k,E as ae,T as F,P as z,c as le,d as H,D as ie,e as ce,f as de,R as ue,g as pe,h as me,i as he,k as fe,L as J,l as ve,m as xe,n as Q,N as ge}from"./vendor-bv2W42_R.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&c(l)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();const je="modulepreload",Se=function(t){return"/"+t},X={},U=function(s,o,c){let i=Promise.resolve();if(o&&o.length>0){const a=document.getElementsByTagName("link");i=Promise.all(o.map(l=>{if(l=Se(l),l in X)return;X[l]=!0;const p=l.endsWith(".css"),x=p?'[rel="stylesheet"]':"";if(!!c)for(let y=a.length-1;y>=0;y--){const S=a[y];if(S.href===l&&(!p||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${x}`))return;const j=document.createElement("link");if(j.rel=p?"stylesheet":je,p||(j.as="script",j.crossOrigin=""),j.href=l,document.head.appendChild(j),p)return new Promise((y,S)=>{j.addEventListener("load",y),j.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${l}`)))})}))}return i.then(()=>s()).catch(a=>{const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a})},Z="http://localhost:9981",ee=()=>Y(`${Z}/api/npmProjects`,{revalidateIfStale:!1,revalidateOnMount:!1,revalidateOnFocus:!1,revalidateOnReconnect:!1}),Re=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function Ce({rootNodeServerStates:t,updateRootNodeServerStates:s,nodeServerState:o}){const[c,i]=v.useState(),{data:a}=ee(),[l]=R.useForm();return v.useEffect(()=>{o.form=l},[o,l]),e.jsxs(R,{form:l,layout:"horizontal",initialValues:o,children:[e.jsx(R.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(b,{})}),e.jsx(R.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(b,{})}),e.jsx(R.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(W,{value:c,onChange:i,children:a==null?void 0:a.map(p=>e.jsx(W.Option,{value:p.id,children:p.path},p.id))})}),e.jsx(R.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(b,{})}),e.jsx(R.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(p,x)=>{try{return new RegExp(String(x)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(b,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(R.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(te,{nodeServerStates:o.postServers??[],prevNodeServerState:o,rootNodeServerStates:t,updateRootNodeServerStates:s})})})]})}let ye=0;function te({rootNodeServerStates:t,updateRootNodeServerStates:s,nodeServerStates:o,prevNodeServerState:c}){const i=()=>{let a=[...o],l=c;for(;l;){l.postServers=a;const p=l.prevServer,x=(p==null?void 0:p.postServers)??t;x[x.indexOf(l)]={...l},a=[...x],l=p}s(a)};return e.jsxs(A,{children:[o.map((a,l)=>e.jsxs(A,{className:"cm1s535",children:[e.jsx(Ce,{nodeServerState:a,updateRootNodeServerStates:s,rootNodeServerStates:t},a.id??a.tmpId),e.jsx(g,{onClick:()=>{o.splice(l,1),i()},children:"删除服务"})]})),e.jsx(O,{className:"c1lck55g",children:Re.map(a=>e.jsxs(g,{type:"primary",onClick:()=>{o.push({...a.value,tmpId:`tmp${ye++}`,prevServer:c}),i()},children:[a.name,"模板"]}))})]})}var E=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(E||{});function Ee(t,s=500){const[o,c]=v.useState(t);return v.useLayoutEffect(()=>{const i=window.setTimeout(()=>c(t),s);return()=>window.clearTimeout(i)},[t,s]),o}function Pe({value:t,onChange:s,...o}){const[c,i]=v.useState(t),a=Ee(c);return v.useEffect(()=>{s(a)},[s,a]),e.jsx(b,{...o,value:c,onChange:l=>{var p;i((p=l.target.value)==null?void 0:p.trim())}})}const Ie="http://localhost:9981",C=async(t,s,o)=>{try{const c=await window.fetch(`${Ie}${t}`,{method:s,...o&&{body:typeof o=="string"?o:JSON.stringify(o)},headers:{"Content-Type":"application/json"}}),i=await c.json();if(c.status!==200)throw new Error(i==null?void 0:i.data);return i.data}catch(c){throw P.error(c==null?void 0:c.message),c}};function Ne({rawLogs:t}){return e.jsx("pre",{className:"c19i87wg",children:t})}const we=t=>fetch(t,{method:"GET"}).then(s=>{var o,c;return(c=(o=s.body)==null?void 0:o.getReader())==null?void 0:c.read()}).then(s=>new TextDecoder().decode(s==null?void 0:s.value).replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,""));function Oe(){var G,K;const{data:t,mutate:s}=ee(),[o,c]=v.useState([]),{nodeIdMapNodeServerResponse:i,rootNodeServerResponses:a}=v.useMemo(()=>{const n={},r={},d=[],u=[];return t==null||t.forEach(m=>{m.nodeServers.forEach(h=>{const f={...h};f.portConfigFileRelativePath=decodeURIComponent(f.portConfigFileRelativePath),f.portReg=decodeURIComponent(f.portReg);const w={...f,postServers:[]};n[f.id]=w,r[f.id]=f,f.prevServerId||(u.push(f),d.push(w))})}),Object.values(n).forEach(m=>{var f;const h=m;h.prevServer=h.prevServerId?n[h.prevServerId]:void 0,h.postServers=((f=h.postServerIds)==null?void 0:f.map(w=>n[w]))??[]}),c(d),{rootNodeServerResponses:u,nodeIdMapNodeServerResponse:r}},[t]),[l,p]=v.useState(null),[x,T]=v.useState(!1),{data:j,mutate:y}=Y(`${Z}/api/nodeServers/runningInfos`,we,{...!x&&{refreshInterval:2e3}}),S=v.useMemo(()=>{const n={};let r=0;return j==null||j.replace(/__\|id:(\d+)\|status:([^|]+)\|__/g,(d,u,m,h)=>(n[Number(u)]={log:j.slice(r,h),status:m,id:Number(u)},r=h+d.length,"")),n},[j]);console.log(S),v.useEffect(()=>{y()},[y]);const L=(n,r)=>C(`/api/nodeServers/${n}/${r}`,"PUT").then(()=>{P.success(`${n}指令已发送`)}),B=(n,r)=>{var m,h;let d="",u="processing";if(!S||n===void 0||n===null||((m=S[n])==null?void 0:m.status)===void 0)d="未开启",u="grey";else{const f=(h=S[n])==null?void 0:h.status;switch(f){case E.CLOSED:d="已关闭",u="grey";break;case E.ERROR:d="错误",u="error";break;case E.COMPILING:d="编译中..",u="processing";break;case E.SUCCESS:d="成功",u="success";break;case E.UNKNOWN:d="未知",u="warning";break;default:{const w=f;throw new Error(w)}}}return e.jsxs(O,{className:"c5s1knt",children:[e.jsx("div",{children:r??""}),e.jsx(le,{bordered:!1,color:u,children:d})]})},_=[{title:"名称",dataIndex:"name",render:(n,r)=>B(r.id,r.name)},{title:"命令",dataIndex:"command"},{title:"地址",render:(n,r)=>{var u;const d=(u=t==null?void 0:t.find(m=>m.id===r.npmProjectId))==null?void 0:u.path;return r.errorField==="PROJECT_PATH"?e.jsx(H,{title:r.errorMsg,children:e.jsx("span",{className:"cg3n9dw",children:d})}):d}},{title:"端口",dataIndex:"port",render:(n,r)=>{if(r.errorMsg)return e.jsx(H,{title:r.errorMsg,children:e.jsx("span",{className:"c1cph1bk",children:r.errorMsg})});const d=Object.values(i).find(u=>u.id!==r.id&&u.port===n);return e.jsx(Pe,{value:n,style:d?{color:"red"}:{},onChange:u=>{String(u)!==String(n)&&C(`/api/nodeServers/changePort/${r.id}/${u}`,"PUT").then(s)}})}},{title:"操作",render:(n,r)=>{const d=S?S[r.id]:null;return e.jsxs(O,{children:[x&&e.jsx(z,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{C(`/api/nodeServers/${r.id}`,"DELETE").then(()=>{P.success("删除成功"),s()})},children:e.jsx(g,{type:"link",children:"删除"})}),!x&&e.jsxs(ie,{disabled:!!r.errorMsg,children:[e.jsx(g,{type:"link",onClick:()=>C(`/api/npmProjects/vscode/${r.npmProjectId}`,"GET"),children:"vscode"}),(!d||d.status===E.CLOSED)&&e.jsx(g,{type:"link",onClick:()=>L("start",r.id),children:"启动"}),d&&e.jsxs(e.Fragment,{children:[e.jsx(g,{type:"link",onClick:()=>p(r.id??null),children:"日志"}),e.jsx(g,{type:"link",onClick:()=>L("restart",r.id),children:"重启"}),d.status!==E.CLOSED&&e.jsx(g,{type:"link",onClick:()=>L("stop",r.id),children:"关闭"})]})]})]})}}],re=n=>{var r;return e.jsx(F,{pagination:!1,dataSource:((r=n.nodeServers)==null?void 0:r.map(d=>({...d,key:d.id})))??[],rowKey:"id",columns:_})};function V(n){const{postServerIds:r}=n;if(!r||r.length===0)return null;const d=r.map(u=>({...i[u],key:u}));return e.jsx(F,{pagination:!1,dataSource:d,columns:_,...r.length>0&&{expandable:{expandedRowRender:V,defaultExpandedRowKeys:r}}})}const[se,I]=v.useState(!1),[M,q]=v.useState(),[N]=R.useForm(),[ne,D]=v.useState(!1);return e.jsxs("div",{children:[e.jsxs(O,{className:"c1oriuqi",children:[e.jsx(oe,{options:["项目分组","服务分组"],defaultValue:x?"项目分组":"服务分组",onChange:n=>{T(n==="项目分组")}}),x&&e.jsxs(e.Fragment,{children:[e.jsx(g,{onClick:()=>{I(!0),N.resetFields()},type:"primary",children:"添加项目"}),e.jsx(g,{onClick:()=>{D(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(g,{onClick:()=>{k.confirm({title:"是否关闭控制台？",icon:e.jsx(ae,{}),content:"关闭后台运行进程",onOk(){C("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!x&&a.length>0&&e.jsx(F,{pagination:!1,dataSource:a.map(n=>({...n,key:n.id})),columns:_,expandable:{expandedRowRender:V,defaultExpandedRowKeys:a.map(n=>n.id)}}),x&&(t!=null&&t.length)?e.jsx(F,{pagination:!1,dataSource:t.map(n=>({...n,key:n.id})),expandable:{expandedRowRender:re,defaultExpandedRowKeys:t==null?void 0:t.map(n=>n.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(n,r)=>e.jsxs(O,{children:[e.jsx(z,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{C(`/api/npmProjects/${r.id}`,"DELETE").then(()=>{P.success("删除成功"),s()})},children:e.jsx(g,{type:"link",children:"删除"})}),e.jsx(g,{type:"primary",onClick:()=>{q(r),I(!0),N.setFieldValue("path",r.path)},children:"编辑"}),e.jsx(g,{type:"primary",onClick:()=>{q(r),I(!0),N.setFieldValue("path",r.path)},children:"添加服务"})]})}]}):null,e.jsx(k,{open:se,title:`${M?"编辑":"添加"}项目`,onCancel:()=>I(!1),onOk:()=>{N.validateFields().then(n=>{if(N.resetFields(),M){C("/api/npmProjects","PUT",{path:n.path,id:M.id}).then(()=>{s(),I(!1),P.success("修改项目成功")});return}C("/api/npmProjects","POST",n).then(()=>{s(),I(!1),P.success("创建项目成功")})})},children:e.jsx(R,{form:N,layout:"vertical",name:"path",children:e.jsx(R.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(b,{})})})}),e.jsx(k,{title:"编辑或添加服务",open:ne,onCancel:()=>{D(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const n=d=>d.map(u=>{var h;const m={...(h=u.form)==null?void 0:h.getFieldsValue(!0)};return m.postServers??(m.postServers=[]),m.portConfigFileRelativePath=encodeURIComponent(m.portConfigFileRelativePath),m.portReg=encodeURIComponent(m.portReg),m.postServers=n(u.postServers),m}),r=n(o);C("/api/nodeServers/batch","POST",r).then(()=>{P.success("保存服务成功"),s(),D(!1)})},width:"80vw",children:e.jsx(te,{nodeServerStates:o,rootNodeServerStates:o,updateRootNodeServerStates:c})}),e.jsx(k,{open:l!==null&&S!==void 0,onCancel:()=>p(null),footer:null,title:e.jsxs(O,{className:"c4u9m77",children:[B(l,l?(G=i[l])==null?void 0:G.name:""),e.jsx(g,{type:"link",onClick:()=>C(`/api/nodeServers/clearLog/${l}`,"GET"),children:"清除日志"})]}),width:"80vw",classNames:{body:"b1ru92bi"},centered:!0,children:e.jsx(Ne,{rawLogs:(K=S[l??-1])==null?void 0:K.log})})]})}const be=t=>fetch(t).then(s=>s.json().then(o=>o.data));function ke(t){switch(t){case"en-US":return U(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(s=>s.default);case"zh-CN":return U(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(s=>s.default);default:return U(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(s=>s.default)}}const $=ce()(t=>({setLocale:async s=>{const o=await ke(s);t({locale:s,messages:o})}})),Fe=()=>{const t=$(c=>c.locale),s=$(c=>c.messages),o=$(c=>c.setLocale);return v.useLayoutEffect(()=>{t||o("zh-CN")},[t,o]),!s||!t?null:e.jsx(me,{locale:t,messages:s,children:e.jsx(he,{value:{fetcher:be,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(fe,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(J,{style:{minHeight:"100vh"},children:e.jsx(J,{children:e.jsx(ve,{children:e.jsxs(xe,{children:[e.jsx(Q,{path:"/nodeServerManagement",element:e.jsx(Oe,{})}),e.jsx(Q,{path:"*",element:e.jsx(ge,{to:"/nodeServerManagement"})})]})})})})})})})};de(document.getElementById("root")).render(e.jsx(ue.StrictMode,{children:e.jsx(pe,{children:e.jsx(Fe,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
