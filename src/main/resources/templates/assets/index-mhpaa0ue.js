import{u as q,j as e,C as Q,B as f,S as O,r as v,F as C,I as b,a as X,s as P,b as de,M as F,E as ue,T,P as Y,c as pe,d as Z,D as me,e as he,f as fe,R as ve,g as xe,h as je,i as ge,k as Se,L as A,l as Re,m as Ce,n as ee,N as ye}from"./vendor-bv2W42_R.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))d(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&d(a)}).observe(document,{childList:!0,subtree:!0});function i(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function d(l){if(l.ep)return;l.ep=!0;const o=i(l);fetch(l.href,o)}})();const Ee="modulepreload",Pe=function(t){return"/"+t},te={},B=function(r,i,d){let l=Promise.resolve();if(i&&i.length>0){const o=document.getElementsByTagName("link");l=Promise.all(i.map(a=>{if(a=Pe(a),a in te)return;te[a]=!0;const m=a.endsWith(".css"),x=m?'[rel="stylesheet"]':"";if(!!d)for(let y=o.length-1;y>=0;y--){const S=o[y];if(S.href===a&&(!m||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${x}`))return;const g=document.createElement("link");if(g.rel=m?"stylesheet":Ee,m||(g.as="script",g.crossOrigin=""),g.href=a,document.head.appendChild(g),m)return new Promise((y,S)=>{g.addEventListener("load",y),g.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${a}`)))})}))}return l.then(()=>r()).catch(o=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o})},K="http://localhost:9981",ne=()=>q(`${K}/api/npmProjects`,{revalidateIfStale:!1,revalidateOnMount:!0,revalidateOnFocus:!1,revalidateOnReconnect:!1}),Ne=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function we({rootNodeServerStates:t,updateRootNodeServerStates:r,nodeServerState:i}){const[d,l]=v.useState(),{data:o}=ne(),[a]=C.useForm();return v.useEffect(()=>{i.form=a},[i,a]),e.jsxs(C,{form:a,layout:"horizontal",initialValues:i,children:[e.jsx(C.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(X,{value:d,onChange:l,children:o==null?void 0:o.map(m=>e.jsx(X.Option,{value:m.id,children:m.path},m.id))})}),e.jsx(C.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(m,x)=>{try{return new RegExp(String(x)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(b,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(C.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(se,{nodeServerStates:i.postServers??[],prevNodeServerState:i,rootNodeServerStates:t,updateRootNodeServerStates:r})})})]})}let Oe=0;function se({rootNodeServerStates:t,updateRootNodeServerStates:r,nodeServerStates:i,prevNodeServerState:d}){const l=()=>{let o=[...i],a=d;for(;a;){a.postServers=o;const m=a.prevServer,x=(m==null?void 0:m.postServers)??t;x[x.indexOf(a)]={...a},o=[...x],a=m}r(o)};return e.jsxs(Q,{children:[i.map((o,a)=>e.jsxs(Q,{className:"cm1s535",children:[e.jsx(we,{nodeServerState:o,updateRootNodeServerStates:r,rootNodeServerStates:t},o.id??o.tmpId),e.jsx(f,{onClick:()=>{i.splice(a,1),l()},children:"删除服务"})]})),e.jsx(O,{className:"c1lck55g",children:Ne.map(o=>e.jsxs(f,{type:"primary",onClick:()=>{i.push({...o.value,tmpId:`tmp${Oe++}`,prevServer:d}),l()},children:[o.name,"模板"]}))})]})}var k=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(k||{});function ke(t,r=500){const[i,d]=v.useState(t);return v.useLayoutEffect(()=>{const l=window.setTimeout(()=>d(t),r);return()=>window.clearTimeout(l)},[t,r]),i}function be({value:t,onChange:r,...i}){const[d,l]=v.useState(t),o=ke(d);return v.useEffect(()=>{r(o)},[r,o]),e.jsx(b,{...i,value:d,onChange:a=>{var m;l((m=a.target.value)==null?void 0:m.trim())}})}const Ie="http://localhost:9981",R=async(t,r,i)=>{try{const d=await window.fetch(`${Ie}${t}`,{method:r,...i&&{body:typeof i=="string"?i:JSON.stringify(i)},headers:{"Content-Type":"application/json"}}),l=await d.json();if(d.status!==200)throw new Error(l==null?void 0:l.data);return l.data}catch(d){throw P.error(d==null?void 0:d.message),d}},Fe=t=>fetch(t,{method:"GET"}).then(r=>r.text()).then(r=>r.replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,"").replace(/(\x00)+/g,`
`));function Te(){var H;const{data:t,mutate:r}=ne(),[i,d]=v.useState([]),{nodeIdMapNodeServerResponse:l,rootNodeServerResponses:o}=v.useMemo(()=>{const s={},n={},c=[],u=[];return t==null||t.forEach(p=>{p.nodeServers.forEach(j=>{const h={...j};h.portConfigFileRelativePath=decodeURIComponent(h.portConfigFileRelativePath),h.portReg=decodeURIComponent(h.portReg);const E={...h,postServers:[]};s[h.id]=E,n[h.id]=h,h.prevServerId||(u.push(h),c.push(E))})}),Object.values(s).forEach(p=>{var h;const j=p;j.prevServer=j.prevServerId?s[j.prevServerId]:void 0,j.postServers=((h=j.postServerIds)==null?void 0:h.map(E=>s[E]))??[]}),d(c),{rootNodeServerResponses:u,nodeIdMapNodeServerResponse:n}},[t]),[a,m]=v.useState(null),[x,M]=v.useState(!1),{data:g,mutate:y}=q(`${K}/api/nodeServers/runningInfos`,{...!x&&{refreshInterval:2e3}}),{data:S,mutate:re}=q(a?`${K}/api/nodeServers/logs/${a}`:void 0,Fe,{...!a!==null&&{refreshInterval:2e3},revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0});v.useEffect(()=>{y()},[y]);const L=(s,n)=>R(`/api/nodeServers/${s}/${n}`,"PUT").then(()=>{P.success(`${s}指令已发送`)}),G=(s,n,c)=>{var j,h;let u="",p="processing";if(!g||s===void 0||s===null||((j=g[s])==null?void 0:j.status)===void 0)u="未开启",p="grey";else{const E=(h=g[s])==null?void 0:h.status;switch(E){case k.CLOSED:u="已关闭",p="grey";break;case k.ERROR:u="错误",p="error";break;case k.COMPILING:u="编译中..",p="processing";break;case k.SUCCESS:u="成功",p="success";break;case k.UNKNOWN:u="未知",p="warning";break;default:{const I=E;throw new Error(I)}}}return e.jsxs(e.Fragment,{children:[e.jsx("div",{children:n??""}),e.jsx(pe,{bordered:!1,color:p,style:c!=null&&c.length&&(c==null?void 0:c.length)>0?{cursor:"pointer"}:{},onClick:()=>{window.location.href=`#${c==null?void 0:c[0]}`},children:u})]})},$=[{title:"名称",dataIndex:"name",render:(s,n)=>e.jsx(O,{className:"c19i87wg",children:G(n.id,n.name)})},{title:"命令",dataIndex:"command"},{title:"地址",render:(s,n)=>{var u;const c=(u=t==null?void 0:t.find(p=>p.id===n.npmProjectId))==null?void 0:u.path;return n.errorField==="PROJECT_PATH"?e.jsx(Z,{title:n.errorMsg,children:e.jsx("span",{className:"c5s1knt",children:c})}):c}},{title:"端口",dataIndex:"port",render:(s,n)=>{if(n.errorMsg)return e.jsx(Z,{title:n.errorMsg,children:e.jsx("span",{className:"cg3n9dw",children:n.errorMsg})});const c=Object.values(l).find(u=>u.id!==n.id&&u.port===s);return e.jsx(be,{value:s,style:c?{color:"red"}:{},onChange:u=>{String(u)!==String(s)&&R(`/api/nodeServers/changePort/${n.id}/${u}`,"PUT").then(r)}})}},{title:"操作",render:(s,n)=>{const c=g?g[n.id]:null;return e.jsxs(O,{children:[x&&e.jsx(Y,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{R(`/api/nodeServers/${n.id}`,"DELETE").then(()=>{P.success("删除成功"),r()})},children:e.jsx(f,{type:"link",children:"删除"})}),!x&&e.jsxs(me,{disabled:!!n.errorMsg,children:[e.jsx(f,{type:"link",onClick:()=>R(`/api/npmProjects/vscode/${n.npmProjectId}`,"GET"),children:"vscode"}),e.jsx(f,{type:"link",onClick:()=>L("start",n.id).then(()=>y()),children:"启动"}),e.jsx(f,{type:"link",onClick:()=>{m(n.id??null)},disabled:!c,children:"日志"}),e.jsx(f,{type:"link",onClick:()=>L("restart",n.id).then(()=>y()),children:"重启"}),e.jsx(f,{type:"link",onClick:()=>L("stop",n.id),children:"关闭"})]})]})}}],ae=s=>{var n;return e.jsx(T,{pagination:!1,dataSource:((n=s.nodeServers)==null?void 0:n.map(c=>({...c,key:c.id})))??[],rowKey:"id",columns:$})};function W(s){const{postServerIds:n}=s;if(!n||n.length===0)return null;const c=n.map(u=>({...l[u],key:u}));return e.jsx(T,{pagination:!1,dataSource:c,columns:$,...n.length>0&&{expandable:{expandedRowRender:W,defaultExpandedRowKeys:n}}})}const[oe,N]=v.useState(!1),[_,z]=v.useState(),[w]=C.useForm(),[ie,U]=v.useState(!1),[le,ce]=v.useMemo(()=>{const s=[];let n=1;const c=[];let u=0;return S==null||S.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(p,j,h,E,I,J)=>{c.push(S.slice(u,J)),u=J+p.length;const D=`error${n++}`;return s.push(D),I?(c.push(e.jsx("h3",{id:D,children:e.jsx("span",{className:"c1cph1bk",children:I})})),p):(c.push(e.jsx(f,{className:"c1oriuqi",type:"link",onClick:()=>{R("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${j}:${h}:${E}`))},target:"_blank",children:e.jsx("h3",{id:D,children:p})})),p)}),S&&c.push(S.slice(u)),[c,s]},[S]);return e.jsxs("div",{children:[e.jsxs(O,{className:"c4u9m77",children:[e.jsx(de,{options:["项目分组","服务分组"],defaultValue:x?"项目分组":"服务分组",onChange:s=>{M(s==="项目分组")}}),x&&e.jsxs(e.Fragment,{children:[e.jsx(f,{onClick:()=>{N(!0),w.resetFields()},type:"primary",children:"添加项目"}),e.jsx(f,{onClick:()=>{U(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(f,{onClick:()=>{F.confirm({title:"是否关闭控制台？",icon:e.jsx(ue,{}),content:"关闭后台运行进程",onOk(){R("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!x&&o.length>0&&e.jsx(T,{pagination:!1,dataSource:o.map(s=>({...s,key:s.id})),columns:$,expandable:{expandedRowRender:W,defaultExpandedRowKeys:o.map(s=>s.id)}}),x&&(t!=null&&t.length)?e.jsx(T,{pagination:!1,dataSource:t.map(s=>({...s,key:s.id})),expandable:{expandedRowRender:ae,defaultExpandedRowKeys:t==null?void 0:t.map(s=>s.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(s,n)=>e.jsxs(O,{children:[e.jsx(Y,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{R(`/api/npmProjects/${n.id}`,"DELETE").then(()=>{P.success("删除成功"),r()})},children:e.jsx(f,{type:"link",children:"删除"})}),e.jsx(f,{type:"primary",onClick:()=>{z(n),N(!0),w.setFieldValue("path",n.path)},children:"编辑"}),e.jsx(f,{type:"primary",onClick:()=>{z(n),N(!0),w.setFieldValue("path",n.path)},children:"添加服务"})]})}]}):null,e.jsx(F,{open:oe,title:`${_?"编辑":"添加"}项目`,onCancel:()=>N(!1),onOk:()=>{w.validateFields().then(s=>{if(w.resetFields(),_){R("/api/npmProjects","PUT",{path:s.path,id:_.id}).then(()=>{r(),N(!1),P.success("修改项目成功")});return}R("/api/npmProjects","POST",s).then(()=>{r(),N(!1),P.success("创建项目成功")})})},children:e.jsx(C,{form:w,layout:"vertical",name:"path",children:e.jsx(C.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(b,{})})})}),e.jsx(F,{title:"编辑或添加服务",open:ie,onCancel:()=>{U(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const s=c=>c.map(u=>{var j;const p={...(j=u.form)==null?void 0:j.getFieldsValue(!0)};return p.postServers??(p.postServers=[]),p.portConfigFileRelativePath=encodeURIComponent(p.portConfigFileRelativePath),p.portReg=encodeURIComponent(p.portReg),p.postServers=s(u.postServers),p}),n=s(i);R("/api/nodeServers/batch","POST",n).then(()=>{P.success("保存服务成功"),r(),U(!1)})},width:"80vw",children:e.jsx(se,{nodeServerStates:i,rootNodeServerStates:i,updateRootNodeServerStates:d})}),e.jsx(F,{open:a!==null&&g!==void 0,onCancel:()=>m(null),footer:null,title:e.jsxs(O,{className:"c1ru92bi",children:[G(a,a?(H=l[a])==null?void 0:H.name:"",ce),e.jsx(f,{type:"link",onClick:()=>R(`/api/nodeServers/clearLog/${a}`,"GET").then(()=>re()),children:"清除日志"})]}),width:"80vw",classNames:{body:"bckpddg"},centered:!0,children:e.jsx("div",{className:"cclyprh",children:le})})]})}const Me=t=>fetch(t).then(r=>r.json().then(i=>i.data));function Le(t){switch(t){case"en-US":return B(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(r=>r.default);case"zh-CN":return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(r=>r.default);default:return B(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(r=>r.default)}}const V=he()(t=>({setLocale:async r=>{const i=await Le(r);t({locale:r,messages:i})}})),$e=()=>{const t=V(d=>d.locale),r=V(d=>d.messages),i=V(d=>d.setLocale);return v.useLayoutEffect(()=>{t||i("zh-CN")},[t,i]),!r||!t?null:e.jsx(je,{locale:t,messages:r,children:e.jsx(ge,{value:{fetcher:Me,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(Se,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(A,{style:{minHeight:"100vh"},children:e.jsx(A,{children:e.jsx(Re,{children:e.jsxs(Ce,{children:[e.jsx(ee,{path:"/nodeServerManagement",element:e.jsx(Te,{})}),e.jsx(ee,{path:"*",element:e.jsx(ye,{to:"/nodeServerManagement"})})]})})})})})})})};fe(document.getElementById("root")).render(e.jsx(ve.StrictMode,{children:e.jsx(xe,{children:e.jsx($e,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
