import{u as V,j as e,C as z,B as g,S as b,r as v,F as R,I as w,a as H,s as E,b as ae,M as F,E as le,T,P as J,c as ie,d as Q,D as ce,e as de,f as ue,R as pe,g as he,h as me,i as fe,k as ve,L as X,l as xe,m as ge,n as Y,N as je}from"./vendor-bv2W42_R.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))i(c);new MutationObserver(c=>{for(const o of c)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(c){const o={};return c.integrity&&(o.integrity=c.integrity),c.referrerPolicy&&(o.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?o.credentials="include":c.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(c){if(c.ep)return;c.ep=!0;const o=n(c);fetch(c.href,o)}})();const Se="modulepreload",Re=function(t){return"/"+t},Z={},D=function(r,n,i){let c=Promise.resolve();if(n&&n.length>0){const o=document.getElementsByTagName("link");c=Promise.all(n.map(a=>{if(a=Re(a),a in Z)return;Z[a]=!0;const p=a.endsWith(".css"),m=p?'[rel="stylesheet"]':"";if(!!i)for(let C=o.length-1;C>=0;C--){const y=o[C];if(y.href===a&&(!p||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${m}`))return;const f=document.createElement("link");if(f.rel=p?"stylesheet":Se,p||(f.as="script",f.crossOrigin=""),f.href=a,document.head.appendChild(f),p)return new Promise((C,y)=>{f.addEventListener("load",C),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${a}`)))})}))}return c.then(()=>r()).catch(o=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o})},q="http://localhost:9981",ee=()=>V(`${q}/api/npmProjects`,{revalidateIfStale:!1,revalidateOnMount:!0,revalidateOnFocus:!1,revalidateOnReconnect:!1}),Ce=[{name:"UiServer",value:{name:"UI-Server",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BffServer",value:{name:"BFF-Server",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"BuildServer",value:{portConfigFileRelativePath:"project.js",portReg:"port:\\s*(\\d+)",command:"npm run build",postServers:[]}}];function ye({rootNodeServerStates:t,updateRootNodeServerStates:r,nodeServerState:n}){const[i,c]=v.useState(),{data:o}=ee(),[a]=R.useForm();return v.useEffect(()=>{n.form=a},[n,a]),e.jsxs(R,{form:a,layout:"horizontal",initialValues:n,children:[e.jsx(R.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(w,{})}),e.jsx(R.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(w,{})}),e.jsx(R.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(H,{value:i,onChange:c,children:o==null?void 0:o.map(p=>e.jsx(H.Option,{value:p.id,children:p.path},p.id))})}),e.jsx(R.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(w,{})}),e.jsx(R.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(p,m)=>{try{return new RegExp(String(m)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(w,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(R.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(te,{nodeServerStates:n.postServers??[],prevNodeServerState:n,rootNodeServerStates:t,updateRootNodeServerStates:r})})})]})}let Ee=0;function te({rootNodeServerStates:t,updateRootNodeServerStates:r,nodeServerStates:n,prevNodeServerState:i}){const c=()=>{let o=[...n],a=i;for(;a;){a.postServers=o;const p=a.prevServer,m=(p==null?void 0:p.postServers)??t;m[m.indexOf(a)]={...a},o=[...m],a=p}r(o)};return e.jsxs(z,{children:[n.map((o,a)=>e.jsxs(z,{className:"cm1s535",children:[e.jsx(ye,{nodeServerState:o,updateRootNodeServerStates:r,rootNodeServerStates:t},o.id??o.tmpId),e.jsx(g,{onClick:()=>{n.splice(a,1),c()},children:"删除服务"})]})),e.jsx(b,{className:"c1lck55g",children:Ce.map(o=>e.jsxs(g,{type:"primary",onClick:()=>{n.push({...o.value,tmpId:`tmp${Ee++}`,prevServer:i}),c()},children:[o.name,"模板"]}))})]})}var k=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(k||{});function Pe(t,r=500){const[n,i]=v.useState(t);return v.useLayoutEffect(()=>{const c=window.setTimeout(()=>i(t),r);return()=>window.clearTimeout(c)},[t,r]),n}function Ie({value:t,onChange:r,...n}){const[i,c]=v.useState(t),o=Pe(i);return v.useEffect(()=>{r(o)},[r,o]),e.jsx(w,{...n,value:i,onChange:a=>{var p;c((p=a.target.value)==null?void 0:p.trim())}})}const Ne="http://localhost:9981",S=async(t,r,n)=>{try{const i=await window.fetch(`${Ne}${t}`,{method:r,...n&&{body:typeof n=="string"?n:JSON.stringify(n)},headers:{"Content-Type":"application/json"}}),c=await i.json();if(i.status!==200)throw new Error(c==null?void 0:c.data);return c.data}catch(i){throw E.error(i==null?void 0:i.message),i}};function Oe({rawLogs:t}){const r=v.useRef(""),n=v.useMemo(()=>{console.log("prevLogs: ",r.current.length),console.log("current logs:",t==null?void 0:t.length),console.log(" logs equal: ",t===r.current),r.current=t??"";const i=[];let c=0;return t==null||t.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(o,a,p,m,P,f)=>(i.push(t.slice(c,f)),c=f+o.length,P?(i.push(e.jsx("span",{className:"c19i87wg",children:P})),o):(i.push(e.jsx(g,{className:"c5s1knt",type:"link",onClick:()=>{S("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${a}:${p}:${m}`))},target:"_blank",children:o})),o))),t&&i.push(t.slice(c)),i},[t]);return e.jsx("div",{className:"cg3n9dw",children:n})}let L="";const be=t=>fetch(t,{method:"GET"}).then(r=>{var n,i;return(i=(n=r.body)==null?void 0:n.getReader())==null?void 0:i.read()}).then(r=>{const n=new TextDecoder().decode(r==null?void 0:r.value);return console.log(" prev fetched ",L.length),console.log("new  fetched: ",n.length),console.log("is Equal: ",n===L),L=n,new TextDecoder().decode(r==null?void 0:r.value).replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,"").replace(/(\x00)+/g,`
`)});function ke(){var W;const{data:t,mutate:r}=ee(),[n,i]=v.useState([]),{nodeIdMapNodeServerResponse:c,rootNodeServerResponses:o}=v.useMemo(()=>{const l={},s={},u=[],d=[];return t==null||t.forEach(h=>{h.nodeServers.forEach(j=>{const x={...j};x.portConfigFileRelativePath=decodeURIComponent(x.portConfigFileRelativePath),x.portReg=decodeURIComponent(x.portReg);const O={...x,postServers:[]};l[x.id]=O,s[x.id]=x,x.prevServerId||(d.push(x),u.push(O))})}),Object.values(l).forEach(h=>{var x;const j=h;j.prevServer=j.prevServerId?l[j.prevServerId]:void 0,j.postServers=((x=j.postServerIds)==null?void 0:x.map(O=>l[O]))??[]}),i(u),{rootNodeServerResponses:d,nodeIdMapNodeServerResponse:s}},[t]),[a,p]=v.useState(null),[m,P]=v.useState(!1),{data:f,mutate:C}=V(`${q}/api/nodeServers/runningInfos`,{...!m&&{refreshInterval:2e3}}),{data:y,mutate:re}=V(a?`${q}/api/nodeServers/logs/${a}`:void 0,be,{...!a!==null&&{refreshInterval:2e3},revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0});v.useEffect(()=>{C()},[C]);const M=(l,s)=>S(`/api/nodeServers/${l}/${s}`,"PUT").then(()=>{E.success(`${l}指令已发送`)}),G=(l,s)=>{var h,j;let u="",d="processing";if(!f||l===void 0||l===null||((h=f[l])==null?void 0:h.status)===void 0)u="未开启",d="grey";else{const x=(j=f[l])==null?void 0:j.status;switch(x){case k.CLOSED:u="已关闭",d="grey";break;case k.ERROR:u="错误",d="error";break;case k.COMPILING:u="编译中..",d="processing";break;case k.SUCCESS:u="成功",d="success";break;case k.UNKNOWN:u="未知",d="warning";break;default:{const O=x;throw new Error(O)}}}return e.jsxs(b,{className:"c1cph1bk",children:[e.jsx("div",{children:s??""}),e.jsx(ie,{bordered:!1,color:d,children:u})]})},_=[{title:"名称",dataIndex:"name",render:(l,s)=>G(s.id,s.name)},{title:"命令",dataIndex:"command"},{title:"地址",render:(l,s)=>{var d;const u=(d=t==null?void 0:t.find(h=>h.id===s.npmProjectId))==null?void 0:d.path;return s.errorField==="PROJECT_PATH"?e.jsx(Q,{title:s.errorMsg,children:e.jsx("span",{className:"c1oriuqi",children:u})}):u}},{title:"端口",dataIndex:"port",render:(l,s)=>{if(s.errorMsg)return e.jsx(Q,{title:s.errorMsg,children:e.jsx("span",{className:"c4u9m77",children:s.errorMsg})});const u=Object.values(c).find(d=>d.id!==s.id&&d.port===l);return e.jsx(Ie,{value:l,style:u?{color:"red"}:{},onChange:d=>{String(d)!==String(l)&&S(`/api/nodeServers/changePort/${s.id}/${d}`,"PUT").then(r)}})}},{title:"操作",render:(l,s)=>{const u=f?f[s.id]:null;return e.jsxs(b,{children:[m&&e.jsx(J,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{S(`/api/nodeServers/${s.id}`,"DELETE").then(()=>{E.success("删除成功"),r()})},children:e.jsx(g,{type:"link",children:"删除"})}),!m&&e.jsxs(ce,{disabled:!!s.errorMsg,children:[e.jsx(g,{type:"link",onClick:()=>S(`/api/npmProjects/vscode/${s.npmProjectId}`,"GET"),children:"vscode"}),e.jsx(g,{type:"link",onClick:()=>M("start",s.id).then(()=>C()),children:"启动"}),e.jsx(g,{type:"link",onClick:()=>{p(s.id??null)},disabled:!u,children:"日志"}),e.jsx(g,{type:"link",onClick:()=>M("restart",s.id).then(()=>C()),children:"重启"}),e.jsx(g,{type:"link",onClick:()=>M("stop",s.id),children:"关闭"})]})]})}}],ne=l=>{var s;return e.jsx(T,{pagination:!1,dataSource:((s=l.nodeServers)==null?void 0:s.map(u=>({...u,key:u.id})))??[],rowKey:"id",columns:_})};function K(l){const{postServerIds:s}=l;if(!s||s.length===0)return null;const u=s.map(d=>({...c[d],key:d}));return e.jsx(T,{pagination:!1,dataSource:u,columns:_,...s.length>0&&{expandable:{expandedRowRender:K,defaultExpandedRowKeys:s}}})}const[se,I]=v.useState(!1),[$,A]=v.useState(),[N]=R.useForm(),[oe,U]=v.useState(!1);return e.jsxs("div",{children:[e.jsxs(b,{className:"c1ru92bi",children:[e.jsx(ae,{options:["项目分组","服务分组"],defaultValue:m?"项目分组":"服务分组",onChange:l=>{P(l==="项目分组")}}),m&&e.jsxs(e.Fragment,{children:[e.jsx(g,{onClick:()=>{I(!0),N.resetFields()},type:"primary",children:"添加项目"}),e.jsx(g,{onClick:()=>{U(!0)},type:"primary",children:"整体编辑服务"})]}),e.jsx(g,{onClick:()=>{F.confirm({title:"是否关闭控制台？",icon:e.jsx(le,{}),content:"关闭后台运行进程",onOk(){S("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!m&&o.length>0&&e.jsx(T,{pagination:!1,dataSource:o.map(l=>({...l,key:l.id})),columns:_,expandable:{expandedRowRender:K,defaultExpandedRowKeys:o.map(l=>l.id)}}),m&&(t!=null&&t.length)?e.jsx(T,{pagination:!1,dataSource:t.map(l=>({...l,key:l.id})),expandable:{expandedRowRender:ne,defaultExpandedRowKeys:t==null?void 0:t.map(l=>l.id)},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(l,s)=>e.jsxs(b,{children:[e.jsx(J,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{S(`/api/npmProjects/${s.id}`,"DELETE").then(()=>{E.success("删除成功"),r()})},children:e.jsx(g,{type:"link",children:"删除"})}),e.jsx(g,{type:"primary",onClick:()=>{A(s),I(!0),N.setFieldValue("path",s.path)},children:"编辑"}),e.jsx(g,{type:"primary",onClick:()=>{A(s),I(!0),N.setFieldValue("path",s.path)},children:"添加服务"})]})}]}):null,e.jsx(F,{open:se,title:`${$?"编辑":"添加"}项目`,onCancel:()=>I(!1),onOk:()=>{N.validateFields().then(l=>{if(N.resetFields(),$){S("/api/npmProjects","PUT",{path:l.path,id:$.id}).then(()=>{r(),I(!1),E.success("修改项目成功")});return}S("/api/npmProjects","POST",l).then(()=>{r(),I(!1),E.success("创建项目成功")})})},children:e.jsx(R,{form:N,layout:"vertical",name:"path",children:e.jsx(R.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(w,{})})})}),e.jsx(F,{title:"编辑或添加服务",open:oe,onCancel:()=>{U(!1)},okText:"保存",cancelText:"取消",onOk:()=>{const l=u=>u.map(d=>{var j;const h={...(j=d.form)==null?void 0:j.getFieldsValue(!0)};return h.postServers??(h.postServers=[]),h.portConfigFileRelativePath=encodeURIComponent(h.portConfigFileRelativePath),h.portReg=encodeURIComponent(h.portReg),h.postServers=l(d.postServers),h}),s=l(n);S("/api/nodeServers/batch","POST",s).then(()=>{E.success("保存服务成功"),r(),U(!1)})},width:"80vw",children:e.jsx(te,{nodeServerStates:n,rootNodeServerStates:n,updateRootNodeServerStates:i})}),e.jsx(F,{open:a!==null&&f!==void 0,onCancel:()=>p(null),footer:null,title:e.jsxs(b,{className:"cckpddg",children:[G(a,a?(W=c[a])==null?void 0:W.name:""),e.jsx(g,{type:"link",onClick:()=>S(`/api/nodeServers/clearLog/${a}`,"GET").then(()=>re()),children:"清除日志"})]}),width:"80vw",classNames:{body:"bclyprh"},centered:!0,children:e.jsx(Oe,{rawLogs:y},y)})]})}const we=t=>fetch(t).then(r=>r.json().then(n=>n.data));function Fe(t){switch(t){case"en-US":return D(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(r=>r.default);case"zh-CN":return D(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(r=>r.default);default:return D(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(r=>r.default)}}const B=de()(t=>({setLocale:async r=>{const n=await Fe(r);t({locale:r,messages:n})}})),Te=()=>{const t=B(i=>i.locale),r=B(i=>i.messages),n=B(i=>i.setLocale);return v.useLayoutEffect(()=>{t||n("zh-CN")},[t,n]),!r||!t?null:e.jsx(me,{locale:t,messages:r,children:e.jsx(fe,{value:{fetcher:we,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(ve,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(X,{style:{minHeight:"100vh"},children:e.jsx(X,{children:e.jsx(xe,{children:e.jsxs(ge,{children:[e.jsx(Y,{path:"/nodeServerManagement",element:e.jsx(ke,{})}),e.jsx(Y,{path:"*",element:e.jsx(je,{to:"/nodeServerManagement"})})]})})})})})})})};ue(document.getElementById("root")).render(e.jsx(pe.StrictMode,{children:e.jsx(he,{children:e.jsx(Te,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
