import{u as W,j as e,C as Y,B as x,S as U,r as j,F as C,I as b,s as N,a as M,b as me,M as $,E as he,T as _,P as Z,c as fe,d as A,D as ve,e as xe,f as je,R as ge,g as Se,h as Re,i as ye,k as Ce,L as ee,l as Ee,m as Ne,n as te,N as Pe}from"./vendor-g2DRWNdn.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function i(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(a){if(a.ep)return;a.ep=!0;const l=i(a);fetch(a.href,l)}})();const Oe="modulepreload",we=function(t){return"/"+t},ne={},G=function(n,i,s){let a=Promise.resolve();if(i&&i.length>0){const l=document.getElementsByTagName("link");a=Promise.all(i.map(d=>{if(d=we(d),d in ne)return;ne[d]=!0;const c=d.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(!!s)for(let E=l.length-1;E>=0;E--){const R=l[E];if(R.href===d&&(!c||R.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${u}`))return;const m=document.createElement("link");if(m.rel=c?"stylesheet":Oe,c||(m.as="script",m.crossOrigin=""),m.href=d,document.head.appendChild(m),c)return new Promise((E,R)=>{m.addEventListener("load",E),m.addEventListener("error",()=>R(new Error(`Unable to preload CSS for ${d}`)))})}))}return a.then(()=>n()).catch(l=>{const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=l,window.dispatchEvent(d),!d.defaultPrevented)throw l})},z="http://localhost:9981",ae=()=>W(`${z}/api/npmProjects`,{revalidateIfStale:!1,revalidateOnMount:!0,revalidateOnFocus:!1,revalidateOnReconnect:!1}),ke=[{name:"微前端UI主服务",value:{name:"微前端UI主服务",portConfigFileRelativePath:".env",portReg:"RENDER_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"微前端BFF主服务",value:{name:"微前端BFF主服务",portConfigFileRelativePath:".env",portReg:"BFF_SERVER_PORT\\s*=\\s*(\\d+)",command:"npm run devserver",postServers:[]}},{name:"微前端Build服务",value:{portConfigFileRelativePath:"project.js",portReg:`port:['"]*\\s*(\\d+)`,command:"npm run build",postServers:[]}}];function be({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerState:i,nodeIdMapNodeServerState:s}){const[a,l]=j.useState(),{data:d}=ae(),[c]=C.useForm();return j.useEffect(()=>{i.form=c},[i,c]),e.jsxs(C,{form:c,layout:"horizontal",initialValues:i,children:[e.jsx(C.Item,{name:"name",label:"名称",rules:[{required:!0,message:"输入服务名称"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"command",label:"npm 命令",rules:[{required:!0,message:"输入npm启动命令"},{pattern:/^npm /,message:"以npm 开头"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"npmProjectId",label:"所属项目",rules:[{required:!0,message:"输入npm启动命令"}],children:e.jsx(U,{value:a,onChange:l,children:d==null?void 0:d.map(u=>e.jsx(U.Option,{value:u.id,children:u.path},u.id))})}),e.jsx(C.Item,{name:"portConfigFileRelativePath",label:"port配置文件相对地址",rules:[{required:!0,message:"输入port配置文件相对地址"}],children:e.jsx(b,{})}),e.jsx(C.Item,{name:"portReg",label:"port配置文件正则",rules:[{required:!0,message:"输入正则"},{validator:(u,S)=>{try{return new RegExp(String(S)),Promise.resolve()}catch{return Promise.reject(new Error("not valid RegExp"))}}}],children:e.jsx(b,{placeholder:"输入正则，必须包含括号以获取端口"})}),e.jsx(C.Item,{label:"子服务",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",rowGap:16},children:e.jsx(oe,{nodeServerStates:i.postServers??[],prevNodeServerState:i,rootNodeServerStates:t,updateRootNodeServerStates:n,nodeIdMapNodeServerState:s})})})]})}let Ie=0;function oe({rootNodeServerStates:t,updateRootNodeServerStates:n,nodeServerStates:i,prevNodeServerState:s,hideAddButtons:a=!1,nodeIdMapNodeServerState:l}){const d=()=>{let c=[...i],u=s;for(;u;){u.postServers=c;const S=u.prevServer,m=(S==null?void 0:S.postServers)??t;m[m.indexOf(u)]={...u},c=[...m],u=S}n(c)};return e.jsxs(Y,{children:[i.map((c,u)=>e.jsxs(Y,{className:"cm1s535",children:[e.jsx(be,{nodeServerState:c,updateRootNodeServerStates:n,rootNodeServerStates:t,nodeIdMapNodeServerState:l},c.id??c.tmpId),e.jsx(x,{onClick:()=>{i.splice(u,1),d()},children:"删除服务"})]})),!a&&e.jsxs("div",{className:"c1lck55g",children:[ke.map(c=>e.jsxs(x,{type:"primary",onClick:()=>{i.push({...c.value,tmpId:`tmp${Ie++}`,prevServer:s}),d()},children:[c.name,"模板"]})),e.jsx("div",{className:"c1ennnnw",children:e.jsx(U,{className:"c1howddn",onChange:c=>{i.push({...l[c],tmpId:`tmp${c++}`,prevServer:s}),d()},children:Object.values(l).map(c=>e.jsx(U.Option,{value:c.id,children:c.name},c.id))})})]})]})}var k=(t=>(t.CLOSED="CLOSED",t.COMPILING="COMPILING",t.ERROR="ERROR",t.SUCCESS="SUCCESS",t.UNKNOWN="UNKNOWN",t))(k||{});function Fe(t,n=500){const[i,s]=j.useState(t);return j.useLayoutEffect(()=>{const a=window.setTimeout(()=>s(t),n);return()=>window.clearTimeout(a)},[t,n]),i}function Te({value:t,onChange:n,...i}){const[s,a]=j.useState(t),l=Fe(s);return j.useEffect(()=>{n(l)},[n,l]),e.jsx(b,{...i,value:s,onChange:d=>{var c;a((c=d.target.value)==null?void 0:c.trim())}})}const Me="http://localhost:9981",y=async(t,n,i)=>{try{const s=await window.fetch(`${Me}${t}`,{method:n,...i&&{body:typeof i=="string"?i:JSON.stringify(i)},headers:{"Content-Type":"application/json"}}),a=await s.json();if(s.status!==200)throw new Error(a==null?void 0:a.data);return a.data}catch(s){throw N.error(s==null?void 0:s.message),s}},Le=t=>fetch(t,{method:"GET"}).then(n=>n.text()).then(n=>n.replace(/\[1m/g,"").replace(/\\x1B/g,"").replace(/\[22m/g,"").replace(/\[32m/g,"").replace(/\[33m/g,"").replace(/\[39m/g,"").replace(//g,"").replace(/(\x00)+/g,`
`)),se="e19i87wg",re=({nodeServerInfo:t,nodeServerId:n,nodeServerName:i,errorAnchorIds:s})=>{var c,u;let a="",l="processing";const d=j.useRef(0);if(!t||n===void 0||n===null||((c=t[n])==null?void 0:c.status)===void 0)a="未开启",l="grey";else{const S=(u=t[n])==null?void 0:u.status;switch(S){case k.CLOSED:a="已关闭",l="grey";break;case k.ERROR:a="错误",l="error";break;case k.COMPILING:a="编译中..",l="processing";break;case k.SUCCESS:a="成功",l="success";break;case k.UNKNOWN:a="未知",l="warning";break;default:{const m=S;throw new Error(m)}}}return e.jsxs(e.Fragment,{children:[e.jsx("div",{children:i??""}),e.jsx(fe,{bordered:!1,color:l,style:s!=null&&s.length&&(s==null?void 0:s.length)>0?{cursor:"pointer"}:{},onClick:()=>{s&&(window.location.href=`#${s==null?void 0:s[d.current]}`,d.current=(d.current+1)%s.length)},children:a})]})};function $e(){var J;const{data:t,mutate:n}=ae(),[i,s]=j.useState([]),{nodeIdMapNodeServerResponse:a,rootNodeServerResponses:l,rootNodeServerStates:d,nodeIdMapNodeServerState:c}=j.useMemo(()=>{const o={},r={},p=[],h=[];return t==null||t.forEach(f=>{f.nodeServers.sort((g,v)=>g.id-v.id),f.nodeServers.forEach(g=>{const v={...g};v.portConfigFileRelativePath=decodeURIComponent(v.portConfigFileRelativePath),v.portReg=decodeURIComponent(v.portReg);const w={...v,postServers:[]};o[v.id]=w,r[v.id]=v,v.prevServerId||(h.push(v),p.push(w))})}),Object.values(o).forEach(f=>{var v;const g=f;g.prevServer=g.prevServerId?o[g.prevServerId]:void 0,g.postServers=((v=g.postServerIds)==null?void 0:v.map(w=>o[w]))??[]}),{rootNodeServerResponses:h,rootNodeServerStates:p,nodeIdMapNodeServerResponse:r,nodeIdMapNodeServerState:o}},[t]),[u,S]=j.useState(null),[m,E]=j.useState(!1),{data:R,mutate:ie}=W(u?`${z}/api/nodeServers/logs/${u}`:void 0,Le,{...!u!==null&&{refreshInterval:2e3},revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0}),B=(o,r)=>y(`/api/nodeServers/${o}/${r}`,"PUT").then(()=>{N.success(`${o}指令已发送`)}),{data:P,mutate:L}=W(`${z}/api/nodeServers/runningInfos`,{...!m&&{refreshInterval:2e3}});j.useEffect(()=>{L()},[L]);const[I,O]=j.useState(null),D=[{title:"名称",dataIndex:"name",render:(o,r)=>e.jsx(M,{className:"c5s1knt",children:e.jsx(re,{nodeServerInfo:P,nodeServerId:r.id,nodeServerName:r.name})})},{title:"命令",dataIndex:"command"},{title:"地址",render:(o,r)=>{var h;const p=(h=t==null?void 0:t.find(f=>f.id===r.npmProjectId))==null?void 0:h.path;return r.errorField==="PROJECT_PATH"?e.jsx(A,{title:r.errorMsg,children:e.jsx("span",{className:"cg3n9dw",children:p})}):p}},{title:"端口",dataIndex:"port",render:(o,r)=>{if(r.errorMsg)return e.jsx(A,{title:r.errorMsg,children:e.jsx("span",{className:"c1cph1bk",children:r.errorMsg})});const p=Object.values(a).find(h=>h.id!==r.id&&h.port===o);return e.jsx(Te,{value:o,style:p?{color:"red"}:{},onChange:h=>{String(h)!==String(o)&&y(`/api/nodeServers/changePort/${r.id}/${h}`,"PUT").then(n)}})}},{title:"操作",render:(o,r)=>{const p=P?P[r.id]:null;return e.jsxs(M,{children:[m&&e.jsx(x,{type:"primary",onClick:()=>{s([{...c[r.id]}]),O("编辑")},children:"编辑"}),m&&e.jsx(Z,{title:"删除服务",description:"是否要删除服务",onConfirm:()=>{y(`/api/nodeServers/${r.id}`,"DELETE").then(()=>{N.success("删除成功"),n()})},children:e.jsx(x,{type:"link",children:"删除"})}),!m&&e.jsxs(ve,{disabled:!!r.errorMsg,children:[e.jsx(x,{type:"link",onClick:()=>y(`/api/npmProjects/vscode/${r.npmProjectId}`,"GET"),children:"vscode"}),e.jsx(x,{type:"link",onClick:()=>B("start",r.id).then(()=>L()),children:"启动"}),e.jsx(x,{type:"link",onClick:()=>{S(r.id??null)},disabled:!p,children:"日志"}),e.jsx(x,{type:"link",onClick:()=>B("restart",r.id).then(()=>L()),children:"重启"}),e.jsx(x,{type:"link",onClick:()=>B("stop",r.id),children:"关闭"})]})]})}}],le=o=>{var r;return e.jsx(_,{pagination:!1,dataSource:((r=o.nodeServers)==null?void 0:r.map(p=>({...p,key:p.id})))??[],rowKey:"id",columns:D})};function H(o){const{postServerIds:r}=o;if(!r||r.length===0)return null;const p=r.map(h=>({...a[h],key:h}));return e.jsx(_,{pagination:!1,dataSource:p,columns:D,expandable:{expandedRowRender:H,defaultExpandedRowKeys:r}})}const[ce,F]=j.useState(!1),[V,de]=j.useState(),[T]=C.useForm(),[ue,pe]=j.useMemo(()=>{const o=[];let r=1;const p=[];let h=0;return R==null||R.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(f,g,v,w,Q,X)=>{p.push(R.slice(h,X)),h=X+f.length;const q=`error${r++}`;return o.push(q),Q?(p.push(e.jsx("h3",{id:q,className:se,children:Q})),f):(p.push(e.jsx("h3",{id:q,className:se,children:e.jsx(x,{type:"link",className:"c1oriuqi",onClick:()=>{y("/api/npmProjects/vscodeError","PUT",encodeURIComponent(`${g}:${v}:${w}`))},target:"_blank",children:f})})),f)}),R&&p.push(R.slice(h)),[p,o]},[R]);return e.jsxs("div",{children:[e.jsxs("div",{className:"c4u9m77",children:[e.jsxs(M,{className:"c1ru92bi",children:[e.jsx(me,{options:["项目分组","服务分组"],defaultValue:m?"项目分组":"服务分组",onChange:o=>{E(o==="项目分组")}}),m&&e.jsxs(e.Fragment,{children:[e.jsx(x,{onClick:()=>{F(!0),T.resetFields()},type:"primary",children:"添加项目"}),e.jsx(x,{onClick:()=>{s(d),O("批量添加修改")},type:"primary",children:"整体编辑"}),e.jsx(x,{type:"primary",onClick:()=>{s([]),O("添加服务")},children:"添加服务"})]})]}),e.jsx(x,{className:"cckpddg",onClick:()=>{$.confirm({title:"是否关闭控制台？",icon:e.jsx(he,{}),content:"关闭后台运行进程",onOk(){y("/api/npmProjects/shutdown","PUT")}})},type:"link",children:"关闭控制台"})]}),!m&&l.length>0&&e.jsx(_,{pagination:!1,dataSource:l.map(o=>({...o,key:o.id})),columns:D,expandable:{expandedRowRender:H,defaultExpandedRowKeys:l.filter(o=>P&&P[o.id]!=null).map(o=>o.id)}}),m&&(t!=null&&t.length)?e.jsx(_,{pagination:!1,dataSource:t.map(o=>({...o,key:o.id})),expandable:{expandedRowRender:le},columns:[{dataIndex:"path",title:"路径"},{title:"操作",render:(o,r)=>e.jsxs(M,{children:[e.jsx(x,{type:"primary",onClick:()=>{de(r),F(!0),T.setFieldValue("path",r.path)},children:"编辑"}),e.jsx(Z,{title:"删除项目",description:"是否要删除项目",onConfirm:()=>{y(`/api/npmProjects/${r.id}`,"DELETE").then(()=>{N.success("删除成功"),n()})},children:e.jsx(x,{type:"link",children:"删除"})})]})}]}):null,e.jsx($,{open:ce,title:`${V?"编辑":"添加"}项目`,onCancel:()=>F(!1),onOk:()=>{T.validateFields().then(o=>{if(T.resetFields(),V){y("/api/npmProjects","PUT",{path:o.path,id:V.id}).then(()=>{n(),F(!1),N.success("修改项目成功")});return}y("/api/npmProjects","POST",o).then(()=>{n(),F(!1),N.success("创建项目成功")})})},children:e.jsx(C,{form:T,layout:"vertical",name:"path",children:e.jsx(C.Item,{name:"path",label:"path",rules:[{required:!0,message:"Please input the path of project"}],children:e.jsx(b,{})})})}),e.jsx($,{title:I,open:I!==null,onCancel:()=>{O(null)},okText:"保存",cancelText:"取消",onOk:()=>{if(I===null)return;const o=p=>p.map(h=>{var g;const f={...(g=h.form)==null?void 0:g.getFieldsValue(!0)};return f.postServers??(f.postServers=[]),f.portConfigFileRelativePath=encodeURIComponent(f.portConfigFileRelativePath),f.portReg=encodeURIComponent(f.portReg),f.postServers=o(h.postServers),f}),r=o(i);if(I==="批量添加修改"){y("/api/nodeServers/batch","POST",r).then(()=>{N.success("保存服务成功"),n(),O(null)});return}r.forEach(p=>{y("/api/nodeServers","POST",p).then(()=>{N.success("保存服务成功"),n(),O(null)})})},width:"80vw",children:e.jsx(oe,{nodeServerStates:i,rootNodeServerStates:i,updateRootNodeServerStates:s,hideAddButtons:I==="编辑",nodeIdMapNodeServerState:c})}),e.jsx($,{open:u!==null&&P!==void 0,onCancel:()=>S(null),footer:null,title:e.jsxs(M,{className:"cclyprh",children:[e.jsx(re,{nodeServerInfo:P,nodeServerId:u,nodeServerName:u?(J=a[u])==null?void 0:J.name:"",errorAnchorIds:pe}),e.jsx(x,{type:"link",onClick:()=>y(`/api/nodeServers/clearLog/${u}`,"GET").then(()=>ie()),children:"清除日志"})]}),width:"80vw",classNames:{body:"b1yofqh6"},centered:!0,children:e.jsx("div",{className:"c12s1pu4",children:ue})})]})}const _e=t=>fetch(t).then(n=>n.json().then(i=>i.data));function Ue(t){switch(t){case"en-US":return G(()=>import("./en-US-WwZ3Ju4A.js"),__vite__mapDeps([])).then(n=>n.default);case"zh-CN":return G(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default);default:return G(()=>import("./zh-CN-XVEU3kbj.js"),__vite__mapDeps([])).then(n=>n.default)}}const K=xe()(t=>({setLocale:async n=>{const i=await Ue(n);t({locale:n,messages:i})}})),Be=()=>{const t=K(s=>s.locale),n=K(s=>s.messages),i=K(s=>s.setLocale);return j.useLayoutEffect(()=>{t||i("zh-CN")},[t,i]),!n||!t?null:e.jsx(Re,{locale:t,messages:n,children:e.jsx(ye,{value:{fetcher:_e,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0,revalidateIfStale:!1},children:e.jsx(Ce,{locale:{locale:t},theme:{token:{colorPrimary:"#7939cb",borderRadius:2,fontSize:16}},children:e.jsx(ee,{style:{minHeight:"100vh"},children:e.jsx(ee,{children:e.jsx(Ee,{children:e.jsxs(Ne,{children:[e.jsx(te,{path:"/nodeServerManagement",element:e.jsx($e,{})}),e.jsx(te,{path:"*",element:e.jsx(Pe,{to:"/nodeServerManagement"})})]})})})})})})})};je(document.getElementById("root")).render(e.jsx(ge.StrictMode,{children:e.jsx(Se,{children:e.jsx(Be,{})})}));
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
