import{r as $,j as t,n as h,i as F,k as G,o as K,T as p,p as B,q as P,t as W,v as A,w as q,x as z,s as H}from"./vendor-2GdBmQ0K.js";import{u as b,j as E,a as J}from"./index-UlzfgvD0.js";import{a as o}from"./types-dHySS9wj.js";var c=(e=>(e.CLOSED="CLOSED",e.COMPILING="COMPILING",e.ERROR="ERROR",e.SUCCESS="SUCCESS",e.UNKNOWN="UNKNOWN",e))(c||{});const S=(e,u)=>E(`${o}/${u}/${e}`,"PUT").then(()=>{H.success(`${e}指令已发送`)}),U=({logInfo:e,process:u,processesId:r,processesName:C,setProcessesId:i,refetchServerInfo:l,onClick:a,refetchLog:N})=>{let n="",s="processing";if((e==null?void 0:e.status)===void 0)n="未开启",s="grey";else{const{status:j}=e;switch(j){case c.CLOSED:n="已关闭",s="grey";break;case c.ERROR:n="错误",s="error";break;case c.COMPILING:n="编译中..",s="processing";break;case c.SUCCESS:n="成功",s="success";break;case c.UNKNOWN:n="未知",s="warning";break;default:console.error(j)}}return t.jsxs("div",{children:[t.jsxs("div",{className:"flex space-x-2 items-center",children:[t.jsx("div",{children:C??""}),t.jsx(K,{bordered:!1,color:s,className:"flex align-middle cursor-pointer",onClick:a,children:n})]}),t.jsxs("div",{className:" text-grey mt-2",children:[t.jsx(p,{title:"启动服务",children:t.jsx(h,{type:"text",disabled:(e==null?void 0:e.status)!==c.CLOSED&&(e==null?void 0:e.status)!==void 0,onClick:()=>{S("start",r).then(()=>l())},className:"text-green-600 cursor-pointer",children:t.jsx(B,{})})}),t.jsx(p,{title:"关闭服务",children:t.jsx(h,{type:"text",disabled:(e==null?void 0:e.status)===c.CLOSED||(e==null?void 0:e.status)===void 0,onClick:()=>{S("stop",r).then(()=>l())},className:"text-red-500 cursor-pointer",children:t.jsx(P,{})})}),t.jsx(p,{title:"重启服务",children:t.jsx(h,{type:"text",onClick:()=>{S("restart",r).then(()=>l())},disabled:(e==null?void 0:e.status)===c.CLOSED||(e==null?void 0:e.status)===void 0,className:"text-green-600 cursor-pointer",children:t.jsx(W,{})})}),t.jsx(p,{title:"查看日志",children:t.jsx(h,{type:"text",onClick:()=>{i(r)},children:t.jsx(A,{})})}),t.jsx(p,{title:"清除日志",children:t.jsx(h,{type:"text",onClick:()=>{E(`${o}/${r}/logs`,"DELETE").then(()=>N())},children:t.jsx(q,{})})}),t.jsx(p,{title:"打开目录",children:t.jsx(h,{type:"text",onClick:()=>{E(`/system/run?command=${encodeURIComponent(`code ${u==null?void 0:u.project.path}`)}`,"GET")},children:t.jsx(z,{})})})]})]})};function Y(){var y;const{data:e,isLoading:u}=b(o),{data:r,mutate:C}=b(`${o}/runningInfos`,{refreshInterval:2e3}),[i,l]=$.useState(null),{data:a,mutate:N}=b(i!==null?`${o}/${i}/logs`:void 0,i!==null?{fetcher:J,refreshInterval:2e3,revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnMount:!0,revalidateOnReconnect:!0}:{}),[n,s]=$.useMemo(()=>{const d=[];let x=1;const m=[];let k=0;return a==null||a.replace(/(?:ERROR in ([^(]+)\((\d+),(\d+)\))|(\berror\b)/gi,(O,D,M,T,L,w)=>{m.push(a.slice(k,w)),k=w+O.length;const v=`error${x++}`;return d.push(v),L?(m.push(t.jsx("h3",{id:v,className:"text-red-500",children:L},v)),O):(m.push(t.jsx("h3",{id:v,className:"text-red-500",children:t.jsx(h,{type:"link",onClick:()=>{E(`/system/run?command=${encodeURIComponent(`code ${D}:${M}:${T}`)}`,"GET")},target:"_blank",children:O})})),O)}),a&&m.push(a.slice(k)),[m,d]},[a]),j=$.useRef(0),R=d=>{i==null&&l(d),!(!s||s.length===0)&&(window.location.href=`#${s==null?void 0:s[j.current]}`,j.current=(j.current+1)%s.length)};return t.jsxs("div",{children:[t.jsx("div",{className:"flex justify-center items-center h-8",children:t.jsx("h2",{className:"mr-auto",children:"服务管理"})}),t.jsx(F,{rowKey:"id",pagination:!1,dataSource:e,loading:u,columns:[{title:"描述",dataIndex:"description",render:(d,x)=>t.jsx("div",{children:t.jsx("div",{children:t.jsx(U,{logInfo:r==null?void 0:r[x.id],processesId:x.id,process:x,processesName:x.description,onClick:()=>R(x.id),setProcessesId:l,refetchServerInfo:C,refetchLog:N})})})},{title:"命令",dataIndex:"command"},{title:"端口",dataIndex:"port"},{dataIndex:["project","path"],title:"地址"}]}),t.jsx(G,{open:i!==null&&r!==void 0,onCancel:()=>l(null),footer:null,title:t.jsx("div",{className:"space-x-5 flex align-middle",children:i!==null&&t.jsx(U,{logInfo:r==null?void 0:r[i],processesId:i,refetchLog:N,process:e==null?void 0:e.find(d=>d.id===i),processesName:(y=e==null?void 0:e.find(d=>d.id===i))==null?void 0:y.description,onClick:()=>R(i),setProcessesId:l,refetchServerInfo:C})}),width:"80vw",classNames:{body:"b1aves2k"},centered:!0,children:t.jsx("pre",{children:n})})]})}export{Y as default};
